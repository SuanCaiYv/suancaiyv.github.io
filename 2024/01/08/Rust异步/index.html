<!DOCTYPE html>
<html lang="en">

<head>

  <!-- Minima -->
  <!-- Hexo theme created by @adisaktijrs -->

  <!-- Basic Page Needs
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  <meta charset="utf-8">

  
  <title>Rustå¼‚æ­¥</title>
  
  <link rel="sitemap" href="http://example.comsitemap.xml,sitemap.txt" />
  
  <link rel="canonical" href="http://example.com/2024/01/08/Rust%E5%BC%82%E6%AD%A5/">
  
  <meta name="description" content="å‰è¨€Rustäº2018å¹´å¼•å…¥å¼‚æ­¥ï¼Œå››å¹´åçš„ä»Šå¤©ï¼Œæˆ‘ç¬¬ä¸€æ¬¡æ¥è§¦Rustä¸”ä½¿ç”¨async&amp;#x2F;awaitå®ç°äº†ä¸€ä¸ªå°çš„IM(å³æ—¶é€šè®¯)ç³»ç»Ÿï¼Œå¸¦ç€åŸæœ¬å¯¹äºRustçš„å¥½å¥‡å’Œå¯¹äºå¼‚æ­¥çš„ç–‘æƒ‘ï¼Œç¿»é˜…äº†ä¸€äº›æ–‡ç« å’Œå‚è€ƒï¼Œæœ€åå¾—åˆ°äº†ä¸€äº›ç­”æ¡ˆã€‚ åœ¨é˜…è¯»ä¹‹å‰ï¼Œå¸Œæœ›è¯»è€…ï¼š  äº†è§£æœ‰é™è‡ªåŠ¨çŠ¶æ€æœº ç†Ÿæ‚‰Rustè¯­æ³• äº†è§£å¹¶">
  
  
  <meta name="author" content="John Doe">
  
  
  
  <meta property="og:site_name" content="Hexo" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Rustå¼‚æ­¥" />
  
  <meta property="og:description" content="å‰è¨€Rustäº2018å¹´å¼•å…¥å¼‚æ­¥ï¼Œå››å¹´åçš„ä»Šå¤©ï¼Œæˆ‘ç¬¬ä¸€æ¬¡æ¥è§¦Rustä¸”ä½¿ç”¨async&amp;#x2F;awaitå®ç°äº†ä¸€ä¸ªå°çš„IM(å³æ—¶é€šè®¯)ç³»ç»Ÿï¼Œå¸¦ç€åŸæœ¬å¯¹äºRustçš„å¥½å¥‡å’Œå¯¹äºå¼‚æ­¥çš„ç–‘æƒ‘ï¼Œç¿»é˜…äº†ä¸€äº›æ–‡ç« å’Œå‚è€ƒï¼Œæœ€åå¾—åˆ°äº†ä¸€äº›ç­”æ¡ˆã€‚ åœ¨é˜…è¯»ä¹‹å‰ï¼Œå¸Œæœ›è¯»è€…ï¼š  äº†è§£æœ‰é™è‡ªåŠ¨çŠ¶æ€æœº ç†Ÿæ‚‰Rustè¯­æ³• äº†è§£å¹¶">
  
  <meta property="og:url" content="http://example.com/2024/01/08/Rust%E5%BC%82%E6%AD%A5/" />

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Rustå¼‚æ­¥">
  
  <meta name="twitter:description" content="å‰è¨€Rustäº2018å¹´å¼•å…¥å¼‚æ­¥ï¼Œå››å¹´åçš„ä»Šå¤©ï¼Œæˆ‘ç¬¬ä¸€æ¬¡æ¥è§¦Rustä¸”ä½¿ç”¨async&amp;#x2F;awaitå®ç°äº†ä¸€ä¸ªå°çš„IM(å³æ—¶é€šè®¯)ç³»ç»Ÿï¼Œå¸¦ç€åŸæœ¬å¯¹äºRustçš„å¥½å¥‡å’Œå¯¹äºå¼‚æ­¥çš„ç–‘æƒ‘ï¼Œç¿»é˜…äº†ä¸€äº›æ–‡ç« å’Œå‚è€ƒï¼Œæœ€åå¾—åˆ°äº†ä¸€äº›ç­”æ¡ˆã€‚ åœ¨é˜…è¯»ä¹‹å‰ï¼Œå¸Œæœ›è¯»è€…ï¼š  äº†è§£æœ‰é™è‡ªåŠ¨çŠ¶æ€æœº ç†Ÿæ‚‰Rustè¯­æ³• äº†è§£å¹¶">
  
  
  
  
  <meta name="twitter:url" content="http://example.com/2024/01/08/Rust%E5%BC%82%E6%AD%A5/" />

  <!-- Mobile Specific Metas
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Preload fonts
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  <link rel="preload" href="/fonts/dm-serif-display-v4-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/fonts/inter-v2-latin-regular.woff2" as="font" type="font/woff2" crossorigin>

  <!-- CSS
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  
<link rel="stylesheet" href="/css/normalize.css">

  
<link rel="stylesheet" href="/css/skeleton.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
<link rel="stylesheet" href="/css/prism-dark.css">

  
<link rel="stylesheet" href="/css/prism-line-numbers.css">

  <!-- User css -->
  
  
<link rel="stylesheet" href="/css/user.css">

  

  <!-- Favicon
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  <link rel="icon" type="image/png" href="/images/favicon.ico">

  <!-- Custom Theme Color Style
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  <style>
  a:not(.icon) {
    text-decoration-color: #0FA0CE;
    background-image: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 0) 50%,
      #0FA0CE 50%
    );
  }
  blockquote {
    border-left: 8px solid #0FA0CE;
  }
  .nanobar .bar {
    background: #0FA0CE;
  }
  .button.button-primary:hover,
  button.button-primary:hover,
  input[type="submit"].button-primary:hover,
  input[type="reset"].button-primary:hover,
  input[type="button"].button-primary:hover,
  .button.button-primary:focus,
  button.button-primary:focus,
  input[type="submit"].button-primary:focus,
  input[type="reset"].button-primary:focus,
  input[type="button"].button-primary:focus {
    background-color: #0FA0CE;
    border-color: #0FA0CE;
  }
  input[type="email"]:focus,
  input[type="number"]:focus,
  input[type="search"]:focus,
  input[type="text"]:focus,
  input[type="tel"]:focus,
  input[type="url"]:focus,
  input[type="password"]:focus,
  textarea:focus,
  select:focus {
    border: 1px solid #0FA0CE;
  }
</style>

  <!-- Google Analytics (With Privacy Settings On)
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  

  
  <script src="/js/pic.min.js" defer></script>
  

  

<meta name="generator" content="Hexo 7.0.0"></head>

<body>
  <div class="container">
    <div class="row">
      <div>

        <div class="row">
  <div class="two columns" style="max-width: 50px">
    <h1 class="mt-2 mode">
      <div onclick=setDarkMode(true) id="darkBtn">ğŸŒ™</div>
      <div onclick=setDarkMode(false) id="lightBtn" class=hidden>â˜€ï¸</div>
      <script >
        if (localStorage.getItem('preferredTheme') == 'dark') {
          setDarkMode(true)
        }
        function setDarkMode(isDark) {
          var darkBtn = document.getElementById('darkBtn')
          var lightBtn = document.getElementById('lightBtn')
          if (isDark) {
            lightBtn.style.display = "block"
            darkBtn.style.display = "none"
            localStorage.setItem('preferredTheme', 'dark');
          } else {
            lightBtn.style.display = "none"
            darkBtn.style.display = "block"
            localStorage.removeItem('preferredTheme');
          }
          document.body.classList.toggle("darkmode");
        }
      </script>
    </h1>
  </div>

  <div class="six columns ml-1">
    <h1 class="mt-2">
      ç»™ä»£ç æ¥ç‚¹Buffï¼
    </h1>
  </div>

  <div class="twelve columns">
    <div class="row">
      <div class="nine columns left">
        <a href="/">Home</a>
        
          
          <a href="/Works" class="ml">Works</a>
          
        
          
          <a href="/About" class="ml">About</a>
          
        
        
          
            <a href="mailto:codewithbuff@163.com" target="_blank" class="ml">Email</a>
          
        
      </div>
    </div>
    <hr style="margin-bottom: 2.6rem">
  </div>
</div>

        <div class="trans">
            <h2>Rustå¼‚æ­¥</h2>

  <p><img src="/2024/01/08/Rust%E5%BC%82%E6%AD%A5/async-rust.svg"></p>
<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>Rustäº2018å¹´å¼•å…¥å¼‚æ­¥ï¼Œå››å¹´åçš„ä»Šå¤©ï¼Œæˆ‘ç¬¬ä¸€æ¬¡æ¥è§¦Rustä¸”ä½¿ç”¨async&#x2F;awaitå®ç°äº†ä¸€ä¸ªå°çš„IM(å³æ—¶é€šè®¯)ç³»ç»Ÿï¼Œå¸¦ç€åŸæœ¬å¯¹äºRustçš„å¥½å¥‡å’Œå¯¹äºå¼‚æ­¥çš„ç–‘æƒ‘ï¼Œç¿»é˜…äº†ä¸€äº›æ–‡ç« å’Œå‚è€ƒï¼Œæœ€åå¾—åˆ°äº†ä¸€äº›ç­”æ¡ˆã€‚</p>
<p>åœ¨é˜…è¯»ä¹‹å‰ï¼Œå¸Œæœ›è¯»è€…ï¼š</p>
<ul>
<li>äº†è§£æœ‰é™è‡ªåŠ¨çŠ¶æ€æœº</li>
<li>ç†Ÿæ‚‰Rustè¯­æ³•</li>
<li>äº†è§£å¹¶ä½¿ç”¨è¿‡Rustå¼‚æ­¥</li>
<li>å¯¹äºReactoræ¨¡å‹(Epoll&#x2F;Kqueueå¤„ç†IO)æœ‰æ‰€äº†è§£</li>
<li>äº†è§£çº¿ç¨‹å’Œåç¨‹ï¼Œåä½œå¼&#x2F;æŠ¢å å¼è°ƒåº¦çš„åŒºåˆ«</li>
</ul>
<h4 id="æœ‰é™è‡ªåŠ¨çŠ¶æ€æœº"><a href="#æœ‰é™è‡ªåŠ¨çŠ¶æ€æœº" class="headerlink" title="æœ‰é™è‡ªåŠ¨çŠ¶æ€æœº"></a>æœ‰é™è‡ªåŠ¨çŠ¶æ€æœº</h4><p>åˆç§°<strong>çŠ¶æ€æœº</strong>ï¼Œç®€ç§°<code>fsm</code>ï¼Œè®¨è®ºä¸€èˆ¬æƒ…å†µï¼Œä¸€ä¸ªçŠ¶æ€æœºç³»ç»Ÿç”±å››ä¸ªå…ƒç´ ç»„æˆï¼š</p>
<ul>
<li>çŠ¶æ€ï¼šState</li>
<li>äº‹ä»¶ï¼šEventï¼Œæˆ–è€…æ¡ä»¶ï¼ŒæŒ‡ä»¤</li>
<li>è¡Œä¸ºï¼šActionï¼Œæˆ–è€…å‡½æ•°ï¼Œæ–¹æ³•</li>
<li>è½¬æ¢ï¼šTransfer</li>
</ul>
<p>ä»¥è‡ªåŠ¨é—¨çš„å¼€å…³ä¸ºä¾‹ï¼Œå¯ä»¥ç”»å‡ºå¦‚ä¸‹çŠ¶æ€æœºè½¬æ¢å›¾ï¼š</p>
<p><img src="/2024/01/08/Rust%E5%BC%82%E6%AD%A5/fsm.svg"></p>
<p><strong>Rustå¯¹äºå¼‚æ­¥çš„å®ç°ä¾èµ–äºçŠ¶æ€æœº</strong>ã€‚</p>
<h4 id="IOå¤šè·¯å¤ç”¨"><a href="#IOå¤šè·¯å¤ç”¨" class="headerlink" title="IOå¤šè·¯å¤ç”¨"></a>IOå¤šè·¯å¤ç”¨</h4><p>Linux&#x2F;macOS&#x2F;Windowsç­‰ç³»ç»Ÿå¯¹äºéé˜»å¡IOçš„å®ç°ä¸ºEpoll&#x2F;Kqueue&#x2F;IOCPï¼Œå…¶ä¸­IOCPæ”¯æŒå¼‚æ­¥éé˜»å¡IOã€‚ä»¥ä¸Šç§°ä¸ºâ€œå¤šè·¯å¤ç”¨IOâ€ï¼Œæ—¨åœ¨å‡å°‘å› ä¸ºç­‰å¾…IOè€Œé€ æˆçš„å¤§é‡çº¿ç¨‹åˆ›å»ºï¼Œ<strong>æé«˜ç³»ç»Ÿè¿æ¥æ•°</strong>ã€‚å…·ä½“ç»†èŠ‚è¿™é‡Œä¸ä¼šè¿›è¡Œé˜è¿°ã€‚</p>
<h4 id="å¼‚æ­¥"><a href="#å¼‚æ­¥" class="headerlink" title="å¼‚æ­¥"></a>å¼‚æ­¥</h4><p>å…³äºæ›´å¥½åœ°å®ç°<strong>IOå¯†é›†å‹</strong>Appçš„ååé‡å’ŒCPUåˆ©ç”¨ç‡ï¼Œç¨‹åºå¹¶è¡ŒåŒ–çš„è¿‡ç¨‹ç»å†äº†ï¼šå¤šè¿›ç¨‹&#x3D;&gt;å¤šçº¿ç¨‹&#x3D;&gt;åç¨‹&#x2F;å¼‚æ­¥ è¿™æ ·çš„å‘å±•è¶‹åŠ¿ã€‚æ¥çœ‹ä¸åŒè¯­è¨€çš„å®ç°ï¼š</p>
<ul>
<li>Javaï¼šLoomå®ç°åç¨‹(å¼€å‘ä¸­)ï¼Œæˆ–è€…Pivotalæå‡ºçš„ReactorProject&#x2F;VertXç­‰é¡¹ç›®å®ç°çš„å“åº”å¼IO</li>
<li>Golangï¼šGoroutineåç¨‹</li>
<li>Kotlinï¼šåç¨‹</li>
<li>Pythonï¼šå¼‚æ­¥</li>
<li>JavaScriptï¼šå¼‚æ­¥</li>
</ul>
<p>å…¶ä¸­åç¨‹åˆ†ä¸ºï¼š</p>
<ul>
<li><strong>æœ‰æ ˆåç¨‹</strong>ï¼šåˆåâ€œç»¿è‰²çº¿ç¨‹â€ã€‚æ¯”å¦‚Goroutineï¼Œæ ˆä¼šéšç€è¿è¡ŒåŠ¨æ€å¢é•¿ï¼Œè¿›è€Œå¼•å…¥äº†æ ˆæ”¶ç¼©ä¼¸å¼ ç­‰é—®é¢˜</li>
<li><strong>æ— æ ˆåç¨‹</strong>ï¼šæ¯”å¦‚Pythonçš„ç”Ÿæˆå™¨ï¼Œä¸åŒçš„æ‰§è¡Œä½“è·‘åœ¨å½“å‰çº¿ç¨‹(æˆ–è€…æ‰§è¡Œè€…çº¿ç¨‹)çš„æ ˆé‡Œï¼Œæ²¡æœ‰ç‹¬å±äºè‡ªå·±çš„æ ˆ</li>
</ul>
<p>å¼‚æ­¥åˆ™æ˜¯åç¨‹çš„ä¸€ç§å˜ç§ï¼ŒRustä¸­é€‰ç”¨äº†è¿™ç§å½¢å¼ï¼Œå¹¶ä¸”è´´è¿‘äºæ— æ ˆåç¨‹ï¼Œå…·ä½“åé¢ä¼šå±•å¼€ã€‚</p>
<p>Rustçš„å¼‚æ­¥æ— æ³•ç›´æ¥è¿è¡Œï¼Œ<strong>ä¾èµ–äºè¿è¡Œæ—¶è¿›è¡Œè°ƒåº¦</strong>ï¼Œç”±äºå®˜æ–¹çš„è¿è¡Œæ—¶æ€§èƒ½æ¬ ç¼ºï¼Œæ‰€ä»¥æ›´å¤šä½¿ç”¨çš„æ˜¯Tokioï¼Œå…·ä½“è§Tokioæ–‡æ¡£ã€‚</p>
<p>Rustä»…ä»…å®šä¹‰äº†å¼‚æ­¥Taskçš„ç”Ÿæˆå’Œå¼‚æ­¥çš„å”¤é†’æ–¹å¼ï¼Œå¹¶æ²¡æœ‰å®šä¹‰å¼‚æ­¥çš„è°ƒåº¦ï¼Œå¯¹äºåº•å±‚æ“ä½œçš„å°è£…(æ¯”å¦‚IOï¼Œå®šæ—¶å™¨ï¼Œé”ç­‰)å’Œå”¤é†’å™¨çš„å®ç°ï¼Œæ‰€ä»¥è¿™å°±ç»™ç¬¬ä¸‰æ–¹æä¾›äº†å¾ˆå¤šçš„å¯èƒ½ï¼Œä¹Ÿä¸ºæˆ‘ä»¬è‡ªå·±å®ç°è‡ªå·±çš„å¼‚æ­¥è¿è¡Œæ—¶æä¾›äº†æœºä¼šã€‚</p>
<h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><h4 id="ç”Ÿæˆå™¨"><a href="#ç”Ÿæˆå™¨" class="headerlink" title="ç”Ÿæˆå™¨"></a>ç”Ÿæˆå™¨</h4><p>å‰é¢æåˆ°ï¼ŒRustçš„å¼‚æ­¥ç±»ä¼¼äºæ— æ ˆåç¨‹ï¼Œè€ŒRust<strong>æ—©æœŸ</strong>å¯¹äºå¼‚æ­¥çš„å°è¯•ï¼Œåˆ™æ˜¯é€šè¿‡<strong>Generatorçš„å½¢å¼å®ç°</strong>çš„ã€‚åœ¨Pythonï¼ŒJavaScriptç­‰è¯­è¨€å‡å¯ä»¥è§åˆ°ç”Ÿæˆå™¨çš„èº«å½±ï¼Œ<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Generator">Generator</a>ã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼Œç”Ÿæˆå™¨è´Ÿè´£ç”Ÿæˆ<strong>æ‰§è¡Œä½“(æˆ–è€…æ‰§è¡Œå‡½æ•°)<strong>ï¼Œä¸€ä¸ªæ‰§è¡Œä½“ç”±</strong>å¯æ‰§è¡Œä»£ç å’Œæ•°æ¡yieldè¯­å¥</strong>ç»„æˆï¼Œ<strong>æ¯ä¸€ä¸ªyieldæŠŠæ‰§è¡Œä½“åˆ‡åˆ†æˆäº†ä¸åŒçš„æ‰§è¡Œé˜¶æ®µ</strong>ã€‚å¯¹äºæ‰§è¡Œä½“çš„æ‰§è¡Œï¼Œä¼šä»ä¸Šä¸€æ¬¡ä¸­æ–­ä½ç½®æ‰§è¡Œï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªyield(åˆæˆ–è€…ç§°ä¸ºä¸­æ–­ç‚¹&#x2F;ä¿å­˜ç‚¹)ä½ç½®ï¼Œæ­¤æ—¶ä¼šä¿å­˜æ‰§è¡Œä½“çš„æ‰§è¡ŒçŠ¶æ€ï¼ŒåŒ…æ‹¬æ›´æ–°ä¹‹åçš„å±€éƒ¨å˜é‡ç­‰ã€‚</p>
<p>é€šè¿‡ä¸Šè¿°æè¿°ï¼Œå¯ä»¥æƒ³åˆ°è¿™å’Œçº¿ç¨‹åˆ‡æ¢æœ‰äº›ç±»ä¼¼ï¼Œå¦‚æœæŠŠæ¯ä¸€ä¸ªçº¿ç¨‹çœ‹æˆä¸€ä¸ªå¯æ‰§è¡Œçš„ç‰‡æ®µï¼Œé‚£ä¹ˆçº¿ç¨‹åˆ‡æ¢ä¹Ÿæ˜¯éœ€è¦ä¿å­˜ä¸Šä¸‹æ–‡ï¼Œè¿›è¡Œä¸‹ä¸€ä¸ªçº¿ç¨‹çš„åˆ‡æ¢(æ‰§è¡Œç‰‡æ®µçš„åˆ‡æ¢ï¼Œä¸è¿‡æ‰§è¡Œç‰‡æ®µæ˜¯å‘åŒä¸€ä¸ªæ–¹å‘æ¨è¿›çš„ï¼Œçº¿ç¨‹åˆ™æ˜¯ç”±è°ƒåº¦ç®—æ³•å†³å®šä¸‹ä¸€ä¸ªæ‰§è¡Œçš„ç›®æ ‡)ã€‚</p>
<p>ç†è§£åˆ°è¿™é‡Œï¼Œå°±ç†è§£äº†å¤§è‡´çš„ç”Ÿæˆå™¨ä½¿ç”¨åŸç†ã€‚</p>
<p>Rustä¹Ÿæ›¾ç»ä½¿ç”¨è¿™ç§æ–¹å¼æ¥å¤„ç†å¼‚æ­¥ï¼Œä½†æ˜¯å› ä¸ºRustçš„ç”Ÿå‘½å‘¨æœŸå’Œå€Ÿç”¨è§„åˆ™çš„å­˜åœ¨ï¼Œå¯¼è‡´è·¨yieldä¿å­˜ä¸Šä¸‹æ–‡å®ç°èµ·æ¥æ¯”è¾ƒå›°éš¾ï¼Œæ‰€ä»¥æ”¹è¿›ä¹‹åå¾—åˆ°äº†ç°åœ¨çš„async&#x2F;awaitï¼Œå³ç”Ÿæˆå™¨æ˜¯Rustå¼‚æ­¥çš„å‰èº«ï¼Œåé¢ä¼šè¯¦ç»†å™è¿°è¿™ä¸€ç‚¹ã€‚</p>
<p>Rustä¸­å¯¹äºç”Ÿæˆå™¨æœ‰ä¸¤ä¸ªä¸»è¦çš„å®šä¹‰ï¼š</p>
<pre><code class="highlight rust"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">Generator</span>&lt;R = ()&gt; &#123;
    <span class="keyword">type</span> <span class="title class_">Yield</span>;

    <span class="keyword">type</span> <span class="title class_">Return</span>;

    <span class="keyword">fn</span> <span class="title function_">resume</span>(<span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">mut</span> <span class="keyword">Self</span>&gt;, arg: R) <span class="punctuation">-&gt;</span> GeneratorState&lt;<span class="keyword">Self</span>::Yield, <span class="keyword">Self</span>::Return&gt;;
&#125;

<span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">GeneratorState</span>&lt;Y, R&gt; &#123;
    <span class="title function_ invoke__">Yielded</span>(Y),

    <span class="title function_ invoke__">Complete</span>(R),
&#125;</code></pre>

<p>è¿™é‡Œçš„<code>GeneratorState</code>åˆ™æ˜¯å¯¹åº”äº†æ‰§è¡Œä½“çš„çŠ¶æ€ï¼Œ<strong>æ¯ä¸€ä¸ªyieldä¸­æ–­ç‚¹</strong>éƒ½ä¼šå¾—åˆ°ä¸€ä¸ª<code>GeneratorState::Yielded</code>çš„æšä¸¾å€¼ï¼Œè€Œæ‰§è¡Œä½“ç»“æŸä¹‹åï¼Œåˆ™ä¼šå¾—åˆ°ä¸€ä¸ª<code>GeneratorState::Complete</code>æšä¸¾å€¼ã€‚</p>
<p>æ­¤å¤–æ³¨æ„åˆ°ï¼Œ<code>Generator::resume()</code>çš„è¿”å›å€¼å¯¹åº”äº†<code>GeneratorState</code>ï¼Œä¾§é¢è¯´æ˜è¿™ä¸ªæ–¹æ³•è´Ÿè´£æ¨è¿›æ‰§è¡Œä½“çš„æ‰§è¡Œã€‚</p>
<p>è‡³äºç¼–è¯‘å™¨å¯¹äºæ‰§è¡Œä½“çš„å®ç°ï¼Œä¸‹é¢ä¼šè¯´ã€‚</p>
<h4 id="ä¸ºä»€ä¹ˆæ˜¯ç”Ÿæˆå™¨ï¼Ÿå¼‚æ­¥å“ªé‡Œå»äº†ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆæ˜¯ç”Ÿæˆå™¨ï¼Ÿå¼‚æ­¥å“ªé‡Œå»äº†ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆæ˜¯ç”Ÿæˆå™¨ï¼Ÿå¼‚æ­¥å“ªé‡Œå»äº†ï¼Ÿ"></a>ä¸ºä»€ä¹ˆæ˜¯ç”Ÿæˆå™¨ï¼Ÿå¼‚æ­¥å“ªé‡Œå»äº†ï¼Ÿ</h4><p>å‰é¢è¯´ç”Ÿæˆå™¨å¯¹äºæ¨ªè·¨ä¿å­˜ç‚¹çš„å¼•ç”¨å¤„ç†ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥ä¼˜åŒ–å¤„ç†ä¹‹åå¾—åˆ°äº†å¼‚æ­¥ã€‚åœ¨ç°åœ¨ç‰ˆæœ¬çš„Rustå¼‚æ­¥ä¸­ï¼Œå…¶å®ç°å’Œ<strong>ç”Ÿæˆå™¨çš„å®ç°çœ‹èµ·æ¥å·®ä¸å¤š</strong>ï¼Œè€Œä»…ä»…åœ¨æŸäº›åè¯æˆ–è€…æ‰§è¡Œæ¨è¿›æ–¹å¼ä¸Šæœ‰æ‰€ä¸åŒã€‚æ­¤å¤–å¯¹äºFutureçš„ç”Ÿæˆä»¥åŠå¤„ç†ï¼Œæ˜¯å’Œç¼–è¯‘å™¨å¼ºè€¦åˆçš„ï¼Œæ‰¾åˆ°ç›¸å…³çš„æ–‡ç« æˆ–è€…æºç ï¼Œä¸å¤ªå®¹æ˜“ï¼Œæ¶‰åŠåˆ°çš„ä»£ç ä¹Ÿä»…æ˜¯LLVM-IRï¼Œæ‰€ä»¥æˆ‘ä»¬å€ŸåŠ©ç”Ÿæˆå™¨æ¥ç†è§£å¹¶å°è¯•ä½¿ç”¨ç”Ÿæˆå™¨æ¨¡æ‹Ÿä¸€ä¸ªå¼‚æ­¥å®šæ—¶å™¨ã€‚</p>
<h4 id="å¼‚æ­¥ä½“ç³»"><a href="#å¼‚æ­¥ä½“ç³»" class="headerlink" title="å¼‚æ­¥ä½“ç³»"></a>å¼‚æ­¥ä½“ç³»</h4><p>Rustçš„å¼‚æ­¥ç»„ä»¶å¯ä»¥åˆ†ä¸ºï¼š</p>
<ul>
<li>Futureï¼šä¼šåœ¨æœªæ¥è¿”å›æŸä¸ªå€¼çš„æ‰§è¡Œä½“</li>
<li>Executorï¼šæ‰§è¡Œå™¨ï¼Œè´Ÿè´£æ¨è¿›Futureçš„æ‰§è¡Œï¼Œè°ƒåº¦å¤šä¸ªFutureï¼Œå“åº”Futureçš„å”¤é†’æ“ä½œ</li>
<li>Wakerï¼šé’ˆå¯¹æŸä¸€Futureç»‘å®šçš„å”¤é†’å™¨ï¼Œç”¨äºå½“å¼‚æ­¥èµ„æºå°±ç»ªæ—¶ï¼Œå”¤é†’æ‰§è¡Œå™¨ç»§ç»­æ¨è¿›</li>
<li>Reactorï¼šä»£è¡¨ä¸€äº›å¼‚æ­¥æ“ä½œï¼Œæ¯”å¦‚ç½‘ç»œï¼Œæ–‡ä»¶IOï¼Œæˆ–è€…å®šæ—¶å™¨ç­‰ä¼šåœ¨æœªæ¥æŸä¸ªæ—¶é—´è§¦å‘çš„è¡Œä¸º</li>
</ul>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œ<strong>å¼‚æ­¥é¢ç›¸IOå¯†é›†å‹App</strong>ï¼Œæ‰€ä»¥ä¸€èˆ¬æ¥è¯´Reactorå°±æ˜¯æœ€åº•å±‚çš„Futureï¼Œå…¶ä»–çš„æ“ä½œåº”è¯¥åµŒå¥—åœ¨Reactoræ“ä½œä¹‹ä¸Šã€‚</p>
<p>å¦‚æœæŒ‰ç…§è¿™æ ·çš„é€»è¾‘å»åˆ’åˆ†ï¼Œåˆ™Futureå¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ul>
<li><strong>å¶å­Future</strong>ï¼šå³æœ¬èº«ä¸ä¼šç­‰å¾…ä»»ä½•å¼‚æ­¥æ“ä½œçš„Futureï¼Œå…¶æœ¬èº«å°±æ˜¯ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶</li>
<li><strong>éå¶å­Future</strong>ï¼šæœ¬èº«çš„æ‰§è¡Œéœ€è¦å…¶ä»–Futureçš„ç»“æœï¼Œè¿™ä¹Ÿæ˜¯å¤§éƒ¨åˆ†å¼€å‘è€…ç¼–å†™çš„Futureçš„å½¢å¼</li>
</ul>
<p>è¿™é‡Œç»™å‡ºä¸€ä¸ªå›¾ç‰‡ï¼š</p>
<p><img src="/2024/01/08/Rust%E5%BC%82%E6%AD%A5/future_tree.svg"></p>
<p>è“è‰²çš„åˆ™æ˜¯åŒ…å«Reactorçš„<strong>å¶å­Future</strong>ï¼Œç´«è‰²çš„æ˜¯åµŒå¥—äº†å…¶ä»–Futureçš„<strong>éå¶å­Future</strong>ï¼›ä¸Šå›¾ä¸­çš„ç®­å¤´å¾ªç¯çš„å«ä¹‰åé¢è§£é‡Šã€‚</p>
<h3 id="ç»†èŠ‚"><a href="#ç»†èŠ‚" class="headerlink" title="ç»†èŠ‚"></a>ç»†èŠ‚</h3><h4 id="Generator"><a href="#Generator" class="headerlink" title="Generator"></a>Generator</h4><p>ä¸Šé¢æåˆ°äº†yieldæœºåˆ¶ï¼Œæ¥çœ‹çœ‹Rustå¯¹äºç”Ÿæˆå™¨ç”Ÿæˆçš„æ‰§è¡Œä½“ï¼Œå…·ä½“ç¼–è¯‘æˆäº†ä»€ä¹ˆæ ·çš„å®ç°ã€‚</p>
<p>å‰æ–‡æåˆ°çŠ¶æ€æœºæ˜¯ä¸å¯ç¼ºå°‘çš„éƒ¨åˆ†ï¼Œè€Œé’ˆå¯¹æ¯ä¸€ä¸ªyieldï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªå…·ä½“çš„çŠ¶æ€ï¼Œå¹¶åœ¨çŠ¶æ€é‡Œä¿å­˜å½“å‰ä¸Šä¸‹æ–‡ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯åœ¨æšä¸¾å€¼é‡Œä¿å­˜å½“å‰æ‰§è¡Œä½“æ¶‰åŠåˆ°çš„å˜é‡ã€‚</p>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨æ¥å®ç°ä¸€ä¸ªæ‰§è¡Œä½“çš„è¿è¡Œï¼Œé€šè¿‡<strong>ç¡¬ç¼–ç æ¨¡æ‹Ÿç¼–è¯‘å™¨ç”Ÿæˆçš„ç»“æœ</strong>ï¼Œç„¶åæ‰‹åŠ¨è°ƒç”¨resumeï¼Œæ¨åŠ¨çŠ¶æ€çš„åˆ‡æ¢ï¼Œä»¥æ­¤è¾¾åˆ°æ‰§è¡Œä½“çš„é˜¶æ®µæ€§æ‰§è¡Œã€‚</p>
<p>è¯·ç¡®ä¿ä½ çš„Rustä¸ºNightlyç‰ˆæœ¬ï¼š</p>
<pre><code class="highlight rust"><span class="meta">#![feature(generators, generator_trait)]</span>

<span class="keyword">use</span> std::&#123;
    pin::Pin,
    sync::&#123;Arc, Mutex&#125;,
    task::Poll,
    time::Duration,
    ops::Generator,
&#125;;

<span class="meta">#[derive(Clone)]</span>
<span class="keyword">struct</span> <span class="title class_">SimpleWaker</span> &#123;
    wake_fn: Arc&lt;Mutex&lt;<span class="type">Box</span>&lt;<span class="keyword">dyn</span> <span class="title function_ invoke__">FnMut</span>() <span class="punctuation">-&gt;</span> () + <span class="built_in">Send</span> + <span class="symbol">&#x27;static</span>&gt;&gt;&gt;,
&#125;

<span class="keyword">impl</span> <span class="title class_">SimpleWaker</span> &#123;
    <span class="keyword">fn</span> <span class="title function_">wake</span>(&amp;<span class="keyword">self</span>) &#123;
        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">wake_fn</span> = <span class="keyword">self</span>.wake_fn.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();
        <span class="title function_ invoke__">wake_fn</span>();
    &#125;

    <span class="keyword">fn</span> <span class="title function_">empty</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;
        SimpleWaker &#123;
            wake_fn: Arc::<span class="title function_ invoke__">new</span>(Mutex::<span class="title function_ invoke__">new</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(|| &#123;&#125;))),
        &#125;
    &#125;

    <span class="keyword">fn</span> <span class="title function_">set_wake_fn</span>(&amp;<span class="keyword">self</span>, wake_fn0: <span class="type">Box</span>&lt;<span class="keyword">dyn</span> <span class="title function_ invoke__">FnMut</span>() <span class="punctuation">-&gt;</span> () + <span class="built_in">Send</span> + <span class="symbol">&#x27;static</span>&gt;) &#123;
        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">wake_fn</span> = <span class="keyword">self</span>.wake_fn.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();
        *wake_fn = wake_fn0;
    &#125;
&#125;

<span class="keyword">struct</span> <span class="title class_">SimpleTimeout</span> &#123;
    duration: Duration,
    timeout: <span class="type">bool</span>,
&#125;

<span class="keyword">impl</span> <span class="title class_">SimpleTimeout</span> &#123;
    <span class="keyword">fn</span> <span class="title function_">poll</span>(<span class="keyword">mut</span> <span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">mut</span> <span class="keyword">Self</span>&gt;, waker: &amp;SimpleWaker) <span class="punctuation">-&gt;</span> Poll&lt;()&gt; &#123;
        <span class="keyword">if</span> <span class="keyword">self</span>.timeout &#123;
            <span class="keyword">return</span> Poll::<span class="title function_ invoke__">Ready</span>(());
        &#125;
        <span class="keyword">let</span> <span class="variable">waker_clone</span> = waker.<span class="title function_ invoke__">clone</span>();
        <span class="keyword">let</span> <span class="variable">duration</span> = <span class="keyword">self</span>.duration;
        std::thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;
            std::thread::<span class="title function_ invoke__">sleep</span>(duration);
            waker_clone.<span class="title function_ invoke__">wake</span>();
        &#125;);
        <span class="keyword">self</span>.timeout = <span class="literal">true</span>;
        Poll::Pending
    &#125;
&#125;

<span class="keyword">fn</span> <span class="title function_">main</span>() &#123;
    <span class="keyword">let</span> <span class="variable">waker0</span> = SimpleWaker::<span class="title function_ invoke__">empty</span>();
    <span class="keyword">let</span> <span class="variable">waker</span> = waker0.<span class="title function_ invoke__">clone</span>();
    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">generator</span> = <span class="keyword">move</span> || &#123;
        <span class="built_in">println!</span>(<span class="string">&quot;test start&quot;</span>);
        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vec</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];
        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">timer</span> = SimpleTimeout &#123;
            duration: Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">1</span>),
            timeout: <span class="literal">false</span>,
        &#125;;
        <span class="keyword">loop</span> &#123;
            <span class="keyword">match</span> Pin::<span class="title function_ invoke__">new</span>(&amp;<span class="keyword">mut</span> timer).<span class="title function_ invoke__">poll</span>(&amp;waker) &#123;
                Poll::<span class="title function_ invoke__">Ready</span>(()) =&gt; &#123;
                    <span class="keyword">break</span>;
                &#125;
                Poll::Pending =&gt; &#123;
                    <span class="title function_ invoke__">yield</span> ();
                &#125;
            &#125;
        &#125;
        vec.<span class="title function_ invoke__">push</span>(<span class="number">4</span>);
        <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, vec);
        <span class="keyword">let</span> <span class="variable">display</span> = <span class="built_in">format!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, vec);
        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">timer</span> = SimpleTimeout &#123;
            duration: Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">1</span>),
            timeout: <span class="literal">false</span>,
        &#125;;
        <span class="keyword">loop</span> &#123;
            <span class="keyword">match</span> Pin::<span class="title function_ invoke__">new</span>(&amp;<span class="keyword">mut</span> timer).<span class="title function_ invoke__">poll</span>(&amp;waker) &#123;
                Poll::<span class="title function_ invoke__">Ready</span>(()) =&gt; &#123;
                    <span class="keyword">break</span>;
                &#125;
                Poll::Pending =&gt; &#123;
                    <span class="title function_ invoke__">yield</span> ();
                &#125;
            &#125;
        &#125;
        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, display);
        <span class="built_in">println!</span>(<span class="string">&quot;test end&quot;</span>);
        <span class="title function_ invoke__">return</span> ();
    &#125;;
    waker0.<span class="title function_ invoke__">set_wake_fn</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(<span class="keyword">move</span> || &#123;
        Pin::<span class="title function_ invoke__">new</span>(&amp;<span class="keyword">mut</span> generator).<span class="title function_ invoke__">resume</span>(());
    &#125;));
    waker0.<span class="title function_ invoke__">wake</span>();
    <span class="keyword">let</span> (_tx, rx) = std::sync::mpsc::channel::&lt;()&gt;();
    _ = rx.<span class="title function_ invoke__">recv</span>();
&#125;
</code></pre>

<p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨simulate()ä¸­å®šä¹‰äº†ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œå¹¶é€šè¿‡çŠ¶æ€æœºè§£é‡Šäº†ç¼–è¯‘ä¹‹åçš„ç»“æœï¼Œç„¶åæ‰‹åŠ¨è°ƒç”¨<code>resume()</code>æ–¹æ³•ï¼Œå°è¯•åˆ‡æ¢çŠ¶æ€ï¼Œå¹¶ä»¥æ­¤æ¨è¿›æ‰§è¡Œï¼Œå¾—åˆ°çš„è¾“å‡ºå’Œé¢„æœŸä¸€è‡´ã€‚</p>
<p>è¿™é‡Œç•™æ„åˆ°å‡ºç°äº†Pinå’ŒæŒ‡é’ˆï¼Œè€Œä¸æ˜¯å¼•ç”¨ã€‚å…³äºä¸ºä»€ä¹ˆä½¿ç”¨æŒ‡é’ˆï¼Œæ˜¯å› ä¸ºåœ¨éœ€è¦ä½¿ç”¨å¼•ç”¨æ—¶ï¼Œç”Ÿå‘½å‘¨æœŸæ— æ³•å·¥ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨åŸç”ŸæŒ‡é’ˆå¹¶æ‰‹åŠ¨æ§åˆ¶æŒ‡é’ˆçš„é‡Šæ”¾å’Œè·å–ã€‚</p>
<p>æ­¤å¤–Pinå› äº<strong>è‡ªå¼•ç”¨</strong>çš„å­˜åœ¨è€Œå­˜åœ¨ï¼Œä¸‹é¢ä¼šæåŠã€‚</p>
<h4 id="Async-Await"><a href="#Async-Await" class="headerlink" title="Async&#x2F;Await"></a>Async&#x2F;Await</h4><p>å‰é¢è¯´åˆ°Rustå¼‚æ­¥çš„å®ç°å’Œç”Ÿæˆå™¨çš„å®ç°å¾ˆåƒï¼Œéƒ½éœ€è¦ä¿å­˜çŠ¶æ€ï¼Œéƒ½ä¼šåˆ†é˜¶æ®µè¿è¡Œï¼Œä¸åŒä¹‹å¤„åœ¨äºasync&#x2F;awaitå®ç°äº†è·¨ä¿å­˜ç‚¹å¼•ç”¨ï¼Œå…·ä½“å®ç°æ–¹å¼åˆ™æ˜¯<strong>æŒ‡é’ˆ+Pin</strong>ï¼›è€Œæ˜¯ç”¨<code>Pin</code>çš„åŸå› å¾ˆç®€å•ï¼Œå› ä¸º<strong>æŒ‡é’ˆä¼šäº§ç”Ÿè‡ªå¼•ç”¨ç±»å‹ï¼Œéœ€è¦Pinä¿è¯è‡ªå¼•ç”¨ç±»å‹çš„æœ‰æ•ˆæ€§</strong>ã€‚</p>
<p>åœ¨å¼‚æ­¥ä¸­ï¼Œå½“è§¦å‘ä¿å­˜ç‚¹ä¿å­˜ä¸Šä¸‹æ–‡æ—¶ï¼Œå¦‚æœå‡ºç°äº†<strong>è·¨åŒ…å­˜ç‚¹çš„å¼•ç”¨</strong>(å› ä¸ºyieldä¿å­˜çš„ä¸Šä¸‹æ–‡å…¶å®æ˜¯æ­¤è¯­å¥åé¢çš„çŠ¶æ€)ï¼Œåˆ™æ”¹ä¸ºè£¸æŒ‡é’ˆå¤„ç†ï¼Œå¹¶ä¸”æŠŠè¢«æŒ‡å‘çš„å€¼ä¸€åŒä¿å­˜åœ¨å½“å‰çŠ¶æ€ä¸­(ä¸ç„¶å› ä¸ºç”Ÿå‘½å‘¨æœŸè€Œå¯¼è‡´è¢«æŒ‡å‘æ•°æ®é”€æ¯ï¼ŒæŒ‡é’ˆéæ³•)ã€‚ä½†æ˜¯è¿™å°±äº§ç”Ÿäº†<strong>è‡ªå¼•ç”¨</strong>ï¼Œæ‰€ä»¥éœ€è¦Pinæ¥å›ºå®šã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœè¿™ä¸ªå€¼è¢«ç§»åŠ¨ï¼Œé‚£ä¹ˆæŒ‡é’ˆæŒ‡å‘çš„æ•°æ®ä¹Ÿä¸å†å¾—åˆ°åˆæ³•æ€§ä¿è¯äº†ä¸æ˜¯å—ï¼Œæ‰€ä»¥æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ä¸è¦è®©å®ƒç§»åŠ¨ã€‚</p>
<h4 id="Pin"><a href="#Pin" class="headerlink" title="Pin"></a>Pin</h4><p>Pinçš„ä¸»è¦ä½œç”¨æ˜¯ä¿è¯è¢«æŒ‡å‘æ•°æ®çš„ä¸å¯ç§»åŠ¨ï¼Œå½“å°è¯•moveä¸€ä¸ªè¢«Pinä¿®é¥°çš„å˜é‡æ—¶ï¼Œä¼šè§¦å‘ä¸€ä¸ªå¼‚å¸¸ï¼Œå…³äºPinçš„å®ç°åˆ™æ˜¯ç”±ç¼–è¯‘å™¨è¿›è¡Œä¿è¯ï¼Œæ¯”è¾ƒç®€å•ã€‚</p>
<p>è€Œæƒ³è¦å®ç°Pinåˆ™åœ¨éœ€è¦è¢«Pinçš„ç±»å‹ä¸Šè¿½åŠ ä¸€ä¸ªå¤§å°ä¸º0çš„æ ‡è®°å­—æ®µï¼Œå…¶ç±»å‹ä¸º<code>PhantomPinned</code>ã€‚åœ¨Rustä¸­ï¼Œç±»å‹é»˜è®¤æ˜¯<code>Unpin</code>çš„ï¼Œå³å¯ä»¥éšä¾¿çš„<code>move</code>ã€‚åŒ…å«äº†<code>Pin</code>å­—æ®µçš„ç±»å‹ä¼šè‡ªåŠ¨å®ç°<code>Pin</code>ã€‚</p>
<p>è¢«Pinçš„æŒ‡é’ˆæ ¹æ®æŒ‡å‘æ•°æ®çš„ä½ç½®åˆ†ä¸ºï¼š</p>
<ul>
<li>æ ˆä¸ŠPinï¼šè¢«Pinçš„æ•°æ®ä¿å­˜åœ¨æ ˆä¸Šï¼Œæ‰€ä»¥æ— æ³•åœ¨<code>new</code>æ–¹æ³•è®¾ç½®è‡ªå¼•ç”¨å­—æ®µï¼Œéœ€è¦åœ¨å¾—åˆ°å®ä¾‹ä¹‹åå†æ¬¡è®¾ç½®è‡ªå¼•ç”¨å­—æ®µçš„å€¼ã€‚è€Œä¸”æ¶‰åŠåˆ°çš„ä¸€äº›æ“ä½œä¼šæ˜¯<code>unsafe</code>çš„ï¼›æ­¤å¤–è¿˜éœ€è¦æ³¨æ„è¢«æå‰é‡Šæ”¾çš„Pinï¼Œå¹¶ä¸ä¼šé‡Šæ”¾èƒŒåçš„å˜é‡ï¼Œæ‰€ä»¥åœ¨<code>drop(Pin)</code>ä¹‹åå¹¶ä¸ä¼šå½±å“é€šè¿‡åŸæœ¬å¼•ç”¨çš„è®¿é—®ï¼Œè€Œè¿™å¯èƒ½äº§ç”Ÿä¸€äº›æ„æ–™ä¹‹å¤–çš„é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦é¢å¤–çš„ç²¾åŠ›å»ç•™æ„ã€‚</li>
<li>å †ä¸ŠPinï¼šç›¸æ¯”ä¹‹å¤–å°±ç®€å•ä¸€äº›ï¼Œä½†æ˜¯è¿™æ˜¯éƒ¨åˆ†çš„æ€§èƒ½ç‰ºç‰²æ¢æ¥çš„ã€‚</li>
</ul>
<p>å…·ä½“ç»†èŠ‚è§<a target="_blank" rel="noopener" href="https://rust-lang.github.io/async-book/04_pinning/01_chapter.html">Pinning</a>ã€‚è¿™é‡Œæˆ‘ä»¬è¯´ä¸€ä¸‹Pinåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>é¦–å…ˆPinç±»å‹åªæœ‰ä¸€ä¸ªå­—æ®µï¼Œå³éœ€è¦è¢«å›ºå®šçš„æ•°æ®çš„<strong>å¯å˜å¼•ç”¨</strong>ç±»å‹ã€‚æ‰€ä»¥Pinå›ºå®šçš„æ˜¯æŸä¸ªå¼•ç”¨èƒŒåçš„æ•°æ®ã€‚</p>
<p>æ—¢ç„¶è¿™é‡Œéœ€è¦å¼•ç”¨ï¼Œé‚£ä¹ˆæ„é€ å¾—åˆ°çš„<strong>Pinå®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸ</strong>(å…³äºå¯¹è±¡å’Œå¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸè¯¦è§ä¹‹å‰çš„ç¬”è®°)å°±<strong>ä¸å¯ä»¥å¤§äºéœ€è¦è¢«å›ºå®šçš„å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸ</strong>ã€‚</p>
<p>å †ä¸Šåˆ†é…æœ¬èº«å¾—åˆ°çš„å°±æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œç›´æ¥æ‹¿ç€è¿™ä¸ªå¼•ç”¨å»æ„é€ Pinï¼Œå¾—åˆ°çš„å®ä¾‹å¯ä»¥å®ç°æ‰€æœ‰æƒè½¬ç§»ï¼Œå› ä¸ºBoxåŒ…å«çš„æ•°æ®ä¸ä¼šè¢«<code>move</code>ï¼Œè¿™é‡Œä»…ä»…æ˜¯ç§»åŠ¨äº†Boxç±»å‹ã€‚è€Œæ ˆä¸Šæ•°æ®ä¼šç›´æ¥ç§»åŠ¨æ•´ä¸ªå˜é‡ï¼Œè¿™ä¹Ÿæ˜¯Pinåœ¨æ ˆä¸Šå’Œå †ä¸Šçš„ä¸€ç‚¹ä¸åŒã€‚</p>
<p>æœ€åä¸ºäº†æ€§èƒ½ï¼Œç»™å‡ºä¸€ä¸ªå»ºè®®å°±æ˜¯ï¼Œèƒ½Pinåœ¨æ ˆä¸Šå°±Pinåœ¨æ ˆä¸Šã€‚é™¤éæœ¬èº«å°±æ˜¯Pinçš„æˆ–è€…æƒ³è¦åœ¨Pinä¹‹åä¾æ—§ç§»åŠ¨æ‰€æœ‰æƒ(ä¸æ˜¯ç§»åŠ¨æ•°æ®)ã€‚</p>
<h5 id="2023-06-01è¿½åŠ "><a href="#2023-06-01è¿½åŠ " class="headerlink" title="2023-06-01è¿½åŠ "></a>2023-06-01è¿½åŠ </h5><p>è¿™é‡Œè¿½åŠ ä¸€ç‚¹å…³äºä¸ºä»€ä¹ˆFuture::poll()éœ€è¦Pin&lt;&amp;mut Self&gt;çš„ç†è§£ï¼Œä»€ä¹ˆè‡ªå¼•ç”¨ç±»å‹å°±ä¸å¤šä»‹ç»äº†ã€‚é¦–å…ˆPinæ²¡æœ‰é‚£ä¹ˆç¥å¥‡ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¡æ¡æ¡†æ¡†ï¼Œä¸€ä¸ªçº¦æŸï¼Œæˆ–è€…è¯´ä¸€ä¸ªé™åˆ¶æ€§æ¥å£ã€‚Pinæœ¬èº«æ˜¯ä½œç”¨äºæŒ‡é’ˆçš„ï¼Œæˆ‘ä»¬ç§°ä¸ºPï¼Œå¦‚æœPæŒ‡å‘çš„ç±»å‹(ç§°ä¸ºT)å®ç°äº†Unpinï¼Œé‚£ä¹ˆPin<P>å’Œ&amp;Pæ²¡ä»€ä¹ˆåŒºåˆ«ï¼ŒPin<mut P>&#x2F;&amp;mut PåŒç†ã€‚ä½†æ˜¯å¦‚æœTå®ç°äº†!Unpinï¼Œå³Téœ€è¦è¢«é’‰ä½ï¼Œåˆ™Pin&lt;P&#x2F;mut P&gt;åªä¼šæš´éœ²å‡ºä¸å¯å˜å¼•ç”¨çš„æ–¹æ³•ï¼Œé€šè¿‡è¿™ç§ç¦æ­¢å¾—åˆ°å¯å˜å¼•ç”¨çš„æ–¹å¼æœç»äº†å¤–éƒ¨ä½¿ç”¨mem::swap()ç­‰ç±»ä¼¼æ–¹æ³•ç§»åŠ¨Tçš„å¯èƒ½ã€‚</p>
<p>è¿™å°±æ˜¯Pinæœ€å¤§çš„çº¦æŸï¼Œç®€è€Œè¨€ä¹‹ï¼Œé€šè¿‡ä½¿ç”¨PinåŒ…è£¹Tçš„å¼•ç”¨ï¼Œå¯ä»¥åœ¨Tâ€œä¸æ„¿æ„â€è¢«ç§»åŠ¨çš„å‰æä¸‹éšè—å¯å˜å¼•ç”¨ï¼Œè¿›è€Œå¸®åŠ©Tå®ç°ä¸æ„¿æ„ç§»åŠ¨çš„æ„¿æœ›ã€‚ä¸€ä¸ªFutureå¯èƒ½ä¼šæ ¹æ®å¤šä¸ªé˜¶æ®µç”Ÿæˆå¤šä¸ªçŠ¶æ€ä¿å­˜ç»“æ„ä½“ï¼Œè¿™é‡Œçš„ç»“æ„ä½“ä¸æ˜¯æ¯ä¸€ä¸ªéƒ½æ˜¯è‡ªå¼•ç”¨çš„ï¼Œç”šè‡³æœ‰æ—¶å…¨éƒ¨éƒ½æ˜¯Unpinçš„ã€‚</p>
<p>å¦å¤–ï¼ŒFutureåœ¨è¢«pollä¹‹å‰æ˜¯å¯ä»¥ç§»åŠ¨çš„ï¼Œå› ä¸ºæ­¤æ—¶æ²¡æœ‰ä»»ä½•çŠ¶æ€ç”Ÿæˆï¼Œä¹Ÿå°±ä¸å­˜åœ¨å› ä¸ºç§»åŠ¨å¯¼è‡´è‡ªå¼•ç”¨å¤±è´¥çš„å¯èƒ½ï¼Œæ‰€ä»¥åœ¨ç”Ÿæˆä¸€ä¸ªFutureä¹‹åå¯ä»¥è‡ªç”±çš„moveï¼ŒSend between threadsã€‚è€Œä¸€æ—¦pollå¼€å§‹ï¼Œåˆ™å¯èƒ½äº§ç”Ÿäº†è‡ªå¼•ç”¨ç»“æ„ä½“ï¼Œæ­¤æ—¶moveæ•´ä¸ªFutureåˆ™ä¼šé€ æˆå´©æºƒï¼Œæ‰€ä»¥æ­¤æ—¶Futureèƒ½å¯¹å¤–æš´éœ²çš„æ‰€æœ‰æ–¹æ³•å¿…å®šæ˜¯Pinä¿®é¥°è¿‡çš„ã€‚</p>
<p>Pinæœ¬èº«æ²¡ä»€ä¹ˆéš¾çš„ï¼Œåªæ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦ä¼šè¢«å„ç§æ–‡ç« å’Œæ¦‚å¿µç»•æ™•ï¼Œå®ƒçš„ä½œç”¨å’Œæ„ä¹‰å¾ˆç®€å•ï¼Œä¹Ÿå¾ˆç›´ç™½ã€‚</p>
<h4 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h4><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä»‹ç»äº†æ‰€æœ‰Futureå®ç°éœ€è¦çš„ç»†èŠ‚ï¼š</p>
<ul>
<li>åˆ†æ®µæ‰§è¡Œ</li>
<li>é˜¶æ®µæ€§å±€éƒ¨å˜é‡ä¿å­˜</li>
<li>è‡ªå¼•ç”¨åˆæ³•æ€§ä¿è¯</li>
</ul>
<p>å‰©ä¸‹çš„å°±æ˜¯å¯¹æ¯”Futureå’ŒGeneratorç„¶åç¡¬ç¼–ç å°è¯•å®ç°ä¸€ä¸ªFutureã€‚</p>
<p>å½“ç„¶è¿˜æœ‰ä¸€ä¸ªè°ƒåº¦å’Œå”¤é†’çš„ç»†èŠ‚ï¼Œæ”¾åœ¨åé¢æåŠã€‚</p>
<p>å‰é¢æåŠFutureåˆ†ä¸º<strong>å¶å­Future</strong>å’Œ<strong>éå¶å­Future</strong>ï¼Œå…¶ä¸­éå¶å­FutureåŒ…å«å…¶ä»–Futureï¼Œè€Œ<strong>éå¶å­Futureçš„æ‰§è¡Œéœ€è¦ç­‰å¾…å†…åµŒçš„Futureçš„æ‰§è¡Œ</strong>ï¼Œå³xxx().awaitï¼›è€Œå¦‚æœæŸä¸ªå¼‚æ­¥æ–¹æ³•æ²¡æœ‰å°±ç»ªï¼Œåˆ™éœ€è¦é‡Šæ”¾CPUä½¿ç”¨æƒï¼Œå³**åœ¨å½“å‰<code>.await</code>ä½ç½®<code>yield</code>**ï¼Œç„¶åç­‰åˆ°å°±ç»ªä¹‹åå†æ¬¡æ¨è¿›ã€‚</p>
<p>çœ‹ï¼è¿™æ˜¯ä¸æ˜¯æŠŠFutureå’ŒGeneratorå¯¹åº”èµ·æ¥äº†ï¼Ÿ**<code>yield</code>éœ€è¦é‡Šæ”¾CPUä¿å­˜æ‰§è¡Œä¸Šä¸‹æ–‡<strong>ï¼ŒåŒæ ·æ— æ³•æ¨è¿›çš„</strong><code>.await</code>æ“ä½œä¹Ÿéœ€è¦é‡Šæ”¾CPUï¼Œä¿å­˜ä¸Šä¸‹æ–‡**ã€‚</p>
<p>æ‰€ä»¥å®ƒä»¬åœ¨å®ç°ä¸ŠåŸºæœ¬ä¸€è‡´ï¼Œä¹Ÿæ˜¯é€šè¿‡çŠ¶æ€æœºå®ç°ï¼Œæ¯ä¸€ä¸ª<code>.await</code>çš„æˆåŠŸæ¨è¿›å¯¹åº”ä¸€ä¸ªçŠ¶æ€çš„è½¬ç§»ã€‚åŒæ—¶åœ¨çŠ¶æ€æšä¸¾å€¼ä¿å­˜ç›®å‰çš„ä¸Šä¸‹æ–‡å˜é‡ã€‚</p>
<p>åˆ†æå®Œéå¶å­èŠ‚ç‚¹ï¼Œæ¥ä¸‹æ¥æ˜¯å¶å­ç»“ç‚¹çš„å¤„ç†ï¼Œ<strong>å¶å­Futureæœ¬èº«ä¸åŒ…å«ä»»ä½•<code>.await</code>æ“ä½œ</strong>ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸å­˜åœ¨ä¿å­˜ä¸Šä¸‹æ–‡ç­‰ç¼–è¯‘å™¨è¡Œä¸ºã€‚</p>
<p>å¯¹å®ƒä»¬çš„å¤„ç†å¾ˆç®€å•ï¼Œå› ä¸ºå®ƒä»¬<strong>åªä¼šè¿”å›<code>Poll::Pending/Poll::Ready</code>ä¸¤ç§ç»“æœ</strong>ï¼Œåœ¨è°ƒåº¦å™¨å¾—åˆ°<code>Poll::Pending</code>ç»“æœæ—¶ï¼Œåˆ‡æ¢åˆ°å¦ä¸€ä¸ªFutureå³å¯ã€‚è€Œåœ¨è°ƒåº¦å™¨è¢«<code>Waker</code>å”¤é†’æ—¶ï¼Œé‡æ–°æ‰§è¡Œå¶å­Futureçš„<code>poll()</code>æ–¹æ³•è¿›è¡Œè½®è¯¢ã€‚</p>
<p>æ‰€ä»¥è¿™é‡Œçš„å¶å­Futureåœ¨å®ç°ä¸Šæœ€å¥½<strong>æŠŠå°±ç»ªæ£€æµ‹æ”¾åœ¨<code>poll()</code>çš„å¼€å§‹</strong>ï¼Œé¿å…é‡å¤æ‰§è¡Œè¿‡å¤šçš„ä¸å¿…è¦éƒ¨åˆ†ã€‚</p>
<p>ä½†æ˜¯è¿™é‡Œåˆæœ‰ä¸€ä¸ªç–‘é—®ï¼Œéå¶å­Futureå¾—åˆ°å¶å­Futureçš„<code>Poll::Pending</code>ç»“æœä¹‹åï¼Œæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿè‚¯å®šä¸å¯èƒ½é‡æ–°æ‰§è¡Œéå¶å­Futureå§ï¼é‚£ä¹ˆæœ€å¥½å°±æ˜¯åœ¨<code>.await</code>è¿™é‡Œä¿å­˜ä¸€ä¸‹ä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”è¿”å›è¿™ä¸ª<code>Poll::Pending</code>ç»“æœï¼Œç­‰åˆ°ä¸‹æ¬¡è°ƒç”¨éFutureçš„poll()æ–¹æ³•æ—¶ï¼Œç»§ç»­è¿™ä¸ªä½ç½®æ‰§è¡Œã€‚è¿™é‡Œç»™å‡ºä¸€ä¸ªå¯èƒ½çš„å®ç°ï¼š</p>
<pre><code class="highlight rust"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">poll</span>() &#123;
    <span class="title function_ invoke__">aaa</span>();
    <span class="title function_ invoke__">bbb</span>();
    <span class="keyword">let</span> <span class="variable">ans</span> = ();
    <span class="keyword">loop</span> &#123;
        <span class="keyword">let</span> <span class="variable">res</span> = some_future.<span class="title function_ invoke__">poll</span>(cx);
        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Poll</span>::Pending = res &#123;
            <span class="keyword">yield</span> Poll::Pending; <span class="comment">// pause execution of code, and reture Pending result to scheduler</span>
        &#125; <span class="keyword">else</span> &#123;
            ans = res.<span class="title function_ invoke__">take</span>();
            <span class="keyword">break</span>;
        &#125;
    &#125;
    <span class="title function_ invoke__">ccc</span>(ans);
    <span class="title function_ invoke__">ddd</span>();
&#125;</code></pre>

<h4 id="await-or-yield-poll-or-resume"><a href="#await-or-yield-poll-or-resume" class="headerlink" title="await or yield &#x2F; poll() or resume()"></a>await or yield &#x2F; poll() or resume()</h4><p>ç°åœ¨è¯•ç€æŠŠç”Ÿæˆå™¨å’Œå¼‚æ­¥å¯¹åº”èµ·æ¥äº†ã€‚æ¯ä¸€ä¸ªawaitå¯¹åº”ä¸€ä¸ªyieldï¼Œawaitè¿”å›<code>Poll::Pending</code>æ—¶ï¼Œåˆ™yieldä¸€ä¸ªPendingï¼Œå¹¶ä¿å­˜ä¸Šä¸‹æ–‡ï¼Œå°±åƒä¸Šé¢æåŠçš„ä¸€æ ·ã€‚awaitè¿”å›<code>Poll::Ready</code>æ—¶ï¼Œåˆ™ç»§ç»­æ¨è¿›æ‰§è¡Œã€‚</p>
<p>æ¯ä¸€æ¬¡çš„<code>poll()</code>è°ƒç”¨ï¼Œå°±åƒé’ˆå¯¹ç”Ÿæˆå™¨è°ƒç”¨<code>resume()</code>ä¸€æ ·ã€‚å°è¯•æ¨è¿›ä¸€æ¬¡çŠ¶æ€ï¼Œå½“ç„¶ä¹Ÿå¯èƒ½ä»<code>Pending</code>ä¾æ—§è½¬ç§»åˆ°<code>Pending</code>ã€‚</p>
<p>è¿™é‡Œç»™å‡ºä¸€ä¸ªé€šè¿‡ç”Ÿæˆå™¨æ¨¡æ‹ŸFutureçš„å¼‚æ­¥è®¡æ•°å™¨ä¾‹å­ï¼š</p>
<pre><code class="highlight rust"><span class="keyword">use</span> std::ops::Generator;
<span class="keyword">use</span> std::pin::Pin;
<span class="keyword">use</span> std::sync::&#123;Arc, Mutex&#125;;
<span class="keyword">use</span> std::sync::mpsc::channel;
<span class="keyword">use</span> std::thread::&#123;sleep, spawn&#125;;
<span class="keyword">use</span> std::time::Duration;

<span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">timer_func</span>() &#123;
    <span class="keyword">let</span> (sender, receiver) = <span class="title function_ invoke__">channel</span>();
    <span class="keyword">let</span> (tx, rx) = <span class="title function_ invoke__">channel</span>();
    <span class="comment">// spawn new Future</span>
    <span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;
        <span class="keyword">let</span> <span class="variable">gen</span> = || &#123;
            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">timeout</span> = <span class="number">1</span>;
            timeout *= <span class="number">2</span>;
            <span class="built_in">println!</span>(<span class="string">&quot;start timer&quot;</span>);
            <span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;
                <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(timeout));
                <span class="keyword">let</span> <span class="variable">_</span> = sender.<span class="title function_ invoke__">send</span>(());
            &#125;);
            <span class="comment">// compiler will save execute context, such as, value of timeout</span>
            <span class="comment">// and the loose the control of this thread</span>
            <span class="keyword">yield</span> timeout;
            <span class="built_in">println!</span>(<span class="string">&quot;timer done with timeout: &#123;&#125;&quot;</span>, timeout);
        &#125;;
        <span class="comment">// send simulated Future to executor thread</span>
        tx.<span class="title function_ invoke__">send</span>(gen).<span class="title function_ invoke__">unwrap</span>();
    &#125;);

    <span class="comment">// executor get new Future</span>
    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">gen</span> = rx.<span class="title function_ invoke__">recv</span>().<span class="title function_ invoke__">unwrap</span>();
    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">gen</span> = Pin::<span class="title function_ invoke__">new</span>(&amp;<span class="keyword">mut</span> gen);
    <span class="comment">// each resume() will run the code in generator until encounter yield</span>
    <span class="comment">// and the next resume() will resume execution of the code in generator from last yield(beginning if first call)</span>
    gen.<span class="title function_ invoke__">as_mut</span>().<span class="title function_ invoke__">resume</span>(());
    <span class="keyword">loop</span> &#123;
        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(_) = receiver.<span class="title function_ invoke__">recv</span>() &#123;
            gen.<span class="title function_ invoke__">as_mut</span>().<span class="title function_ invoke__">resume</span>(());
        &#125; <span class="keyword">else</span> &#123;
            <span class="keyword">break</span>
        &#125;
    &#125;
&#125;</code></pre>

<p>è¿˜è®°å¾—æˆ‘ä»¬å‰é¢è¯´çš„Futureè°ƒç”¨å…³ç³»å›¾é‡Œé¢çš„ç®­å¤´å—ï¼Ÿé‚£äº›åŒ…å«ä¸åŒå°ç®­å¤´çš„Task(ä¸€ç§å®ç°äº†Futureçš„ç±»å‹)ï¼Œåˆ™æ˜¯è¡¨ç¤ºå¯¹äºå­Futureçš„è°ƒç”¨å¹¶åœ¨è¿”å›<code>Poll::Pending</code>æ—¶å¾ªç¯ï¼Œä¸è¿‡ä¼šé‡Šæ”¾CPUã€‚è€Œæ¯ä¸€ä¸ªåˆ†æ”¯æœ€ä¸‹é¢çš„Taskçš„ç®­å¤´æŒ‡å‘äº†æœ€å¼€å§‹ï¼Œè¡¨ç¤ºä»–ä»¬æ˜¯å¶å­Futureï¼Œä¸”ä¼šåœ¨æ¯ä¸€æ¬¡è°ƒç”¨æ—¶é‡æ–°åˆ¤æ–­å°±ç»ªçŠ¶æ€ã€‚</p>
<h4 id="Waker"><a href="#Waker" class="headerlink" title="Waker"></a>Waker</h4><p>æœ€åçš„å¶å­Futureå°±ç»ªæ—¶ï¼Œæ€ä¹ˆè§¦å‘å†æ¬¡poll()å‘¢ï¼Ÿè‚¯å®šä¸èƒ½è®©æ‰§è¡Œå™¨loopå§ï¼æ‰€ä»¥éœ€è¦ä¸€ä¸ªé€šçŸ¥æœºåˆ¶ï¼Œåœ¨è¿™é‡Œå°±æ˜¯Wakerã€‚</p>
<p>Rustå¯¹äºWakerå¹¶æ²¡æœ‰é™åˆ¶å…¶å®ç°ï¼Œè€Œæ˜¯ä»…ä»…ç»™å‡ºäº†æ ‡å‡†ï¼Œå…·ä½“å®ç°å–å†³äºè¿è¡Œæ—¶çš„åå¥½ã€‚å¯¹äºWakerï¼Œæˆ‘ä»¬æœ‰å¦‚ä¸‹ç»“æ„ï¼š</p>
<p><img src="/2024/01/08/Rust%E5%BC%82%E6%AD%A5/waker.svg"></p>
<p>Rustå¹¶æ²¡æœ‰ä½¿ç”¨ç‰¹å¾å¯¹è±¡å®ç°Wakerï¼Œè€Œæ˜¯ä½¿ç”¨äº†ç¡¬ç¼–ç çš„è™šæ–¹æ³•è¡¨å’Œæ•°æ®åŸŸï¼Œä¹Ÿå°±æ˜¯èƒ–çº¸é’ˆç±»å‹ã€‚é¦–å…ˆæ˜¯ContextåŒ…è£¹äº†ä¸€ä¸ªWakerç±»å‹ï¼Œä¹‹æ‰€ä»¥ä¸ç›´æ¥ä½¿ç”¨æ˜¯ä¸ºäº†æ—¥åæ‰©å±•Contextã€‚</p>
<p>è€ŒWakeråˆ™åŒ…å«ä¸€ä¸ªRawWakerï¼Œè€ŒRawWakeråˆ™æ˜¯ç”±è¿è¡Œæ—¶å…·ä½“å®ç°çš„Wakerï¼ŒRawWakeråŒ…å«ä¸€ä¸ªæ•°æ®åŸŸå’Œä¸€ä¸ªè™šæ–¹æ³•è¡¨ï¼Œç”¨æ¥å®ç°ç±»ä¼¼åŠ¨æ€æ´¾å‘çš„åŠŸèƒ½ï¼Œè¿™ä¹ˆåšçš„åŸå› æ˜¯å› ä¸ºæŸäº›åµŒå…¥å¼ç³»ç»Ÿä¸æ”¯æŒç‰¹å¾å¯¹è±¡ã€‚</p>
<p>RawWakeræ­£å¦‚ä¸€ä¸ªç‰¹å¾å¯¹è±¡ä¸€ä¸ªï¼Œæœ‰ä¸¤ä¸ªå­—æ®µï¼Œå¤§å°ä¸º2*sizeof(uzise)ï¼Œ64ä½æœºå°±æ˜¯16å­—èŠ‚ï¼›èƒ–çº¸é’ˆï¼Œå¯¹å§ï¼Ÿ</p>
<p>é’ˆå¯¹æ¯ä¸€ä¸ªFutureï¼Œè¿è¡Œæ—¶ä¼šåˆ›å»ºä¸€ä¸ªTaskï¼Œç”¨æ¥åŒ…è£¹Wakerå’ŒFutureï¼Œæˆ–è€…è¯´ï¼ŒTaskå®ç°äº†Futureï¼ŒåŒæ—¶åŒ…å«Wakerå­—æ®µã€‚è€Œåœ¨pollæ–¹æ³•é‡Œçš„åˆé€‚çš„åœ°æ–¹ï¼Œè°ƒç”¨waker.wake()æ–¹æ³•ï¼Œè§¦å‘è°ƒåº¦å™¨çš„å†è°ƒåº¦ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´Wakerçš„å®ç°å¯èƒ½æœ‰ï¼š</p>
<ul>
<li>Task IDçš„å½¢å¼ï¼šé’ˆå¯¹æ¯ä¸€ä¸ªTaskåŸºäºä¸€ä¸ªIDï¼Œå¹¶é€šè¿‡wakerä¼ é€’IDç»™æ‰§è¡Œå™¨ï¼Œå‘Šè¯‰å®ƒå“ªä¸ªTaskå°±ç»ªäº†ã€‚</li>
<li>å¼•ç”¨è®¡æ•°ï¼šè¿™ä¹Ÿæ˜¯æœ€å¤šå®ç°çš„å½¢å¼ï¼ŒWakeræœ¬èº«åœ¨æ•°æ®åŸŸä¿å­˜ä¸€ä¸ªå¯¹åº”Taskçš„å¼•ç”¨(é€šè¿‡Arcè¿™æ ·çš„å½¢å¼)ï¼Œå¹¶åœ¨å°±ç»ªæ—¶æŠŠè¿™ä¸ªå¼•ç”¨æ·»åŠ åˆ°å¯æ‰§è¡Œé˜Ÿåˆ—ä¸­ã€‚ä¸€èˆ¬å”¤é†’å™¨ä¼šåœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´ä¼ é€’ï¼Œæ¯”å¦‚è°ƒåº¦çº¿ç¨‹å’Œå·¥ä½œçº¿ç¨‹ï¼Œæ‰€ä»¥ä¼šä½¿ç”¨ArcåšåŒæ­¥ã€‚</li>
</ul>
<h4 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h4><p>è´Ÿè´£ç”ŸæˆTaskï¼Œè°ƒåº¦Taskï¼Œç»‘å®šWakerç­‰ã€‚</p>
<p>è¿™é‡Œç»™å‡ºä¸€ä¸ªå¯èƒ½çš„è°ƒåº¦å™¨ï¼ŒWakerç­‰å®ç°ï¼š</p>
<pre><code class="highlight rust"><span class="keyword">use</span> std::collections::&#123;hash_map, HashMap&#125;;
<span class="keyword">use</span> std::future::Future;
<span class="keyword">use</span> std::mem::&#123;forget, replace&#125;;
<span class="keyword">use</span> std::pin::Pin;
<span class="keyword">use</span> std::sync::&#123;Arc, Mutex&#125;;
<span class="keyword">use</span> std::sync::mpsc::&#123;channel, Sender&#125;;
<span class="keyword">use</span> std::task::&#123;Context, Poll, RawWaker, RawWakerVTable, Waker&#125;;
<span class="keyword">use</span> std::thread::&#123;JoinHandle, spawn, sleep, Thread, current, park&#125;;
<span class="keyword">use</span> std::time::Duration;

<span class="keyword">enum</span> <span class="title class_">Event</span> &#123;
    Close,
    <span class="title function_ invoke__">Timeout</span>(<span class="type">u64</span>, <span class="type">usize</span>),
&#125;

<span class="keyword">enum</span> <span class="title class_">TaskState</span> &#123;
    <span class="title function_ invoke__">Polling</span>(Waker),
    Ready,
    Finished,
&#125;

<span class="keyword">struct</span> <span class="title class_">Reactor</span> &#123;
    <span class="comment">// send event to executor thread</span>
    <span class="comment">// å‘é€ç»™æ‰§è¡Œçº¿ç¨‹çš„Sender</span>
    dispatcher: Sender&lt;Event&gt;,
    handle: <span class="type">Option</span>&lt;JoinHandle&lt;()&gt;&gt;,
    <span class="comment">// the map of task id and task state</span>
    <span class="comment">// ä»»åŠ¡idå’Œä»»åŠ¡çŠ¶æ€çš„æ˜ å°„</span>
    tasks: HashMap&lt;<span class="type">usize</span>, TaskState&gt;
&#125;

<span class="keyword">impl</span> <span class="title class_">Reactor</span> &#123;
    <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> Arc&lt;Mutex&lt;<span class="type">Box</span>&lt;<span class="keyword">Self</span>&gt;&gt;&gt; &#123;
        <span class="keyword">let</span> (sender, receiver) = <span class="title function_ invoke__">channel</span>();
        <span class="keyword">let</span> <span class="variable">reactor</span> = Arc::<span class="title function_ invoke__">new</span>(Mutex::<span class="title function_ invoke__">new</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(Reactor &#123;
            dispatcher: sender,
            handle: <span class="literal">None</span>,
            tasks: HashMap::<span class="title function_ invoke__">new</span>(),
        &#125;)));
        <span class="keyword">let</span> <span class="variable">clone</span> = Arc::<span class="title function_ invoke__">downgrade</span>(&amp;reactor);
        <span class="keyword">let</span> <span class="variable">handle</span> = <span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;
            <span class="comment">// join all timer thread by this vector</span>
            <span class="comment">// é€šè¿‡è¿™ä¸ªVecæ¥joinæ‰€æœ‰çš„å®šæ—¶å™¨çº¿ç¨‹</span>
            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];
            <span class="keyword">for</span> <span class="variable">event</span> <span class="keyword">in</span> receiver &#123;
                <span class="keyword">let</span> <span class="variable">reactor</span> = clone.<span class="title function_ invoke__">clone</span>();
                <span class="keyword">match</span> event &#123;
                    Event::Close =&gt; &#123;
                        <span class="keyword">break</span>;
                    &#125;
                    Event::<span class="title function_ invoke__">Timeout</span>(timeout, id) =&gt; &#123;
                        <span class="keyword">let</span> <span class="variable">event_handle</span> = <span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;
                            <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(timeout));
                            <span class="comment">// it&#x27;s time to wake up.</span>
                            <span class="keyword">let</span> <span class="variable">reactor</span> = reactor.<span class="title function_ invoke__">upgrade</span>().<span class="title function_ invoke__">unwrap</span>();
                            reactor.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">map</span>(|<span class="keyword">mut</span> rect| rect.<span class="title function_ invoke__">wake</span>(id)).<span class="title function_ invoke__">unwrap</span>();
                        &#125;);
                        handles.<span class="title function_ invoke__">push</span>(event_handle);
                    &#125;
                &#125;
            &#125;
            <span class="comment">// join all timer thread</span>
            <span class="comment">// joinæ‰€æœ‰çš„å®šæ—¶å™¨çº¿ç¨‹</span>
            handles.<span class="title function_ invoke__">into_iter</span>().for_each(|handle| handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>());
        &#125;);
        reactor.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">map</span>(|<span class="keyword">mut</span> rect| rect.handle = <span class="title function_ invoke__">Some</span>(handle)).<span class="title function_ invoke__">unwrap</span>();
        reactor
    &#125;

    <span class="comment">// the wake is trying to transfer the task state</span>
    <span class="comment">// and that is how the fsm work with Future in Rust.</span>
    <span class="comment">// wakeæ–¹æ³•å°è¯•è½¬æ¢ä»»åŠ¡çŠ¶æ€ï¼Œè¿™å°±æ˜¯Rustå¦‚ä½•ä½¿ç”¨fsmæ¥å®ç°Futureçš„ã€‚</span>
    <span class="keyword">fn</span> <span class="title function_">wake</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, id: <span class="type">usize</span>) &#123;
        <span class="keyword">let</span> <span class="variable">state</span> = <span class="keyword">self</span>.tasks.<span class="title function_ invoke__">get_mut</span>(&amp;id).<span class="title function_ invoke__">unwrap</span>();
        <span class="comment">// update corresponding task state</span>
        <span class="comment">// æ›´æ–°å¯¹åº”çš„ä»»åŠ¡çŠ¶æ€</span>
        <span class="keyword">match</span> <span class="title function_ invoke__">replace</span>(state, TaskState::Ready) &#123;
            <span class="comment">// wake with the waker bound on the event</span>
            <span class="comment">// ç”¨ç»‘å®šåœ¨äº‹ä»¶ä¸Šçš„wakerå”¤é†’</span>
            TaskState::<span class="title function_ invoke__">Polling</span>(waker) =&gt; &#123;
                waker.<span class="title function_ invoke__">wake</span>();
            &#125;,
            TaskState::Finished =&gt; &#123;
                <span class="built_in">panic!</span>(<span class="string">&quot;task already finished&quot;</span>);
            &#125;,
            _ =&gt; &#123;&#125;
        &#125;
    &#125;

    <span class="keyword">fn</span> <span class="title function_">register</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, timeout: <span class="type">u64</span>, waker: Waker, id: <span class="type">usize</span>) &#123;
        <span class="keyword">if</span> <span class="keyword">self</span>.tasks.<span class="title function_ invoke__">insert</span>(id, TaskState::<span class="title function_ invoke__">Polling</span>(waker)).<span class="title function_ invoke__">is_some</span>() &#123;
            <span class="built_in">panic!</span>(<span class="string">&quot;task already registered&quot;</span>);
        &#125;
        <span class="keyword">self</span>.dispatcher.<span class="title function_ invoke__">send</span>(Event::<span class="title function_ invoke__">Timeout</span>(timeout, id)).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;send channel broken down&quot;</span>);
    &#125;

    <span class="keyword">fn</span> <span class="title function_">is_ready</span>(&amp;<span class="keyword">self</span>, id: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;
        <span class="keyword">match</span> <span class="keyword">self</span>.tasks.<span class="title function_ invoke__">get</span>(&amp;id) &#123;
            <span class="title function_ invoke__">Some</span>(TaskState::Ready) =&gt; <span class="literal">true</span>,
            _ =&gt; <span class="literal">false</span>,
        &#125;
    &#125;
&#125;

<span class="keyword">impl</span> <span class="title class_">Drop</span> <span class="keyword">for</span> <span class="title class_">Reactor</span> &#123;
    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;
        <span class="comment">// close executor thread</span>
        <span class="comment">// å…³é—­æ‰§è¡Œçº¿ç¨‹</span>
        <span class="keyword">self</span>.dispatcher.<span class="title function_ invoke__">send</span>(Event::Close).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;send channel broken down&quot;</span>);
        <span class="comment">// waiting for remaining work</span>
        <span class="comment">// ç­‰å¾…å‰©ä½™çš„å·¥ä½œæ‰§è¡Œ</span>
        <span class="keyword">self</span>.handle.<span class="title function_ invoke__">take</span>().<span class="title function_ invoke__">map</span>(|handle| handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>()).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;reactor thread already joined&quot;</span>);
    &#125;
&#125;

<span class="keyword">struct</span> <span class="title class_">MyWaker</span> &#123;
    thread_handle: Thread,
&#125;

<span class="keyword">impl</span> <span class="title class_">MyWaker</span> &#123;
    <span class="keyword">fn</span> <span class="title function_">wake</span>(&amp;<span class="keyword">self</span>) &#123;
        <span class="keyword">self</span>.thread_handle.<span class="title function_ invoke__">unpark</span>();
    &#125;

    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> RawWaker &#123;
        <span class="keyword">let</span> <span class="variable">arc</span> = <span class="keyword">unsafe</span> &#123; Arc::<span class="title function_ invoke__">from_raw</span>(<span class="keyword">self</span>) &#125;;
        <span class="comment">// just increase the reference count, decrease it when drop</span>
        <span class="comment">// åªå¢åŠ å¼•ç”¨è®¡æ•°ï¼Œdropæ—¶ä¼šå†å‡å›å»</span>
        forget(arc.<span class="title function_ invoke__">clone</span>());
        <span class="comment">// all the waker here share the same data field</span>
        <span class="comment">// æ‰€æœ‰çš„wakeréƒ½å…±äº«åŒä¸€ä¸ªæ•°æ®åŸŸ</span>
        RawWaker::<span class="title function_ invoke__">new</span>(Arc::<span class="title function_ invoke__">into_raw</span>(arc) <span class="keyword">as</span> *<span class="title function_ invoke__">const</span> (), &amp;VTABLE)
    &#125;

    <span class="keyword">fn</span> <span class="title function_">into</span>(waker: *<span class="keyword">const</span> MyWaker) <span class="punctuation">-&gt;</span> Waker &#123;
        <span class="keyword">let</span> <span class="variable">raw_waker</span> = RawWaker::<span class="title function_ invoke__">new</span>(waker <span class="keyword">as</span> *<span class="title function_ invoke__">const</span> (), &amp;VTABLE);
        <span class="keyword">unsafe</span> &#123; Waker::<span class="title function_ invoke__">from_raw</span>(raw_waker) &#125;
    &#125;
&#125;

<span class="keyword">const</span> VTABLE: RawWakerVTable = <span class="keyword">unsafe</span> &#123;
    RawWakerVTable::<span class="title function_ invoke__">new</span>(
        |data| &#123;
            MyWaker::<span class="title function_ invoke__">clone</span>(&amp;(*(data <span class="keyword">as</span> *<span class="keyword">const</span> MyWaker)))
        &#125;,
        |data| &#123;
            MyWaker::<span class="title function_ invoke__">wake</span>(&amp;(*(data <span class="keyword">as</span> *<span class="keyword">const</span> MyWaker)))
        &#125;,
        |data| &#123;
            &amp;(*(data <span class="keyword">as</span> *<span class="keyword">const</span> MyWaker)).thread_handle.<span class="title function_ invoke__">unpark</span>();
        &#125;,
        |data| &#123;
            <span class="title function_ invoke__">drop</span>(Arc::<span class="title function_ invoke__">from_raw</span>(data <span class="keyword">as</span> *<span class="keyword">const</span> MyWaker));
        &#125;,
    )
&#125;;

<span class="keyword">struct</span> <span class="title class_">MyTask</span> &#123;
    id: <span class="type">usize</span>,
    reactor: Arc&lt;Mutex&lt;<span class="type">Box</span>&lt;Reactor&gt;&gt;&gt;,
    data: <span class="type">u64</span>,
&#125;

<span class="keyword">impl</span> <span class="title class_">MyTask</span> &#123;
    <span class="keyword">fn</span> <span class="title function_">new</span>(id: <span class="type">usize</span>, reactor: Arc&lt;Mutex&lt;<span class="type">Box</span>&lt;Reactor&gt;&gt;&gt;, data: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;
        <span class="keyword">Self</span> &#123; id, reactor, data &#125;
    &#125;
&#125;

<span class="keyword">impl</span> <span class="title class_">Future</span> <span class="keyword">for</span> <span class="title class_">MyTask</span> &#123;
    <span class="keyword">type</span> <span class="title class_">Output</span> = <span class="type">usize</span>;

    <span class="comment">// this method can be invoked many times</span>
    <span class="comment">// è¿™ä¸ªæ–¹æ³•å¯èƒ½ä¼šè¢«å¤šæ¬¡è°ƒç”¨</span>
    <span class="keyword">fn</span> <span class="title function_">poll</span>(<span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">mut</span> <span class="keyword">Self</span>&gt;, cx: &amp;<span class="keyword">mut</span> Context&lt;<span class="symbol">&#x27;_</span>&gt;) <span class="punctuation">-&gt;</span> Poll&lt;<span class="keyword">Self</span>::Output&gt; &#123;
        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">reactor</span> = <span class="keyword">self</span>.reactor.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();
        <span class="keyword">if</span> reactor.<span class="title function_ invoke__">is_ready</span>(<span class="keyword">self</span>.id) &#123;
            *reactor.tasks.<span class="title function_ invoke__">get_mut</span>(&amp;<span class="keyword">self</span>.id).<span class="title function_ invoke__">unwrap</span>() = TaskState::Finished;
            Poll::<span class="title function_ invoke__">Ready</span>(<span class="keyword">self</span>.id)
        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">hash_map</span>::Entry::<span class="title function_ invoke__">Occupied</span>(<span class="keyword">mut</span> e) = reactor.tasks.<span class="title function_ invoke__">entry</span>(<span class="keyword">self</span>.id) &#123;
            <span class="comment">// on each invoke, the corresponding waker will be updated</span>
            <span class="comment">// the old waker will be dropped.</span>
            <span class="comment">// æ¯æ¬¡è°ƒç”¨æ—¶ï¼Œå¯¹åº”çš„wakeréƒ½ä¼šè¢«æ›´æ–°ï¼Œæ—§çš„wakerä¼šè¢«ä¸¢å¼ƒ</span>
            e.<span class="title function_ invoke__">insert</span>(TaskState::<span class="title function_ invoke__">Polling</span>(cx.<span class="title function_ invoke__">waker</span>().<span class="title function_ invoke__">clone</span>()));
            Poll::Pending
        &#125; <span class="keyword">else</span> &#123;
            <span class="comment">// in the first invoke, a pair of id-task_state will be inserted into the map</span>
            <span class="comment">// åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œä¸€ä¸ªid-task_stateä¼šè¢«æ’å…¥åˆ°mapä¸­</span>
            reactor.<span class="title function_ invoke__">register</span>(<span class="keyword">self</span>.data, cx.<span class="title function_ invoke__">waker</span>().<span class="title function_ invoke__">clone</span>(), <span class="keyword">self</span>.id);
            Poll::Pending
        &#125;
    &#125;
&#125;

<span class="keyword">fn</span> <span class="title function_">block_on</span>&lt;F&gt;(<span class="keyword">mut</span> future: F) <span class="punctuation">-&gt;</span> F::Output
    <span class="keyword">where</span> F: Future &#123;
    <span class="keyword">let</span> <span class="variable">current_thread</span> = <span class="title function_ invoke__">current</span>();
    <span class="comment">// all timer share the same waker</span>
    <span class="comment">// æ‰€æœ‰çš„å®šæ—¶å™¨å…±äº«åŒä¸€ä¸ªwakerï¼Œæ˜¯ä¸ºäº†ç®€å•è®¾è®¡</span>
    <span class="keyword">let</span> <span class="variable">my_waker</span> = Arc::<span class="title function_ invoke__">new</span>(MyWaker &#123; thread_handle: current_thread &#125;);
    <span class="keyword">let</span> <span class="variable">waker</span> = MyWaker::<span class="title function_ invoke__">into</span>(Arc::<span class="title function_ invoke__">into_raw</span>(my_waker));
    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">context</span> = Context::<span class="title function_ invoke__">from_waker</span>(&amp;waker);
    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">future</span> = <span class="keyword">unsafe</span> &#123;Pin::<span class="title function_ invoke__">new_unchecked</span>(&amp;<span class="keyword">mut</span> future) &#125;;
    <span class="keyword">loop</span> &#123;
        <span class="keyword">match</span> Future::<span class="title function_ invoke__">poll</span>(future.<span class="title function_ invoke__">as_mut</span>(), &amp;<span class="keyword">mut</span> context) &#123;
            Poll::Pending =&gt; &#123;
                <span class="title function_ invoke__">park</span>();
            &#125;,
            Poll::<span class="title function_ invoke__">Ready</span>(value) =&gt; &#123;
                <span class="keyword">break</span> value
            &#125;
        &#125;;
    &#125;
&#125;

<span class="keyword">fn</span> <span class="title function_">run</span>() &#123;
    <span class="keyword">let</span> <span class="variable">reactor</span> = Reactor::<span class="title function_ invoke__">new</span>();
    <span class="keyword">let</span> <span class="variable">task1</span> = MyTask::<span class="title function_ invoke__">new</span>(<span class="number">1</span>, reactor.<span class="title function_ invoke__">clone</span>(), <span class="number">1</span>);
    <span class="keyword">let</span> <span class="variable">task2</span> = MyTask::<span class="title function_ invoke__">new</span>(<span class="number">2</span>, reactor.<span class="title function_ invoke__">clone</span>(), <span class="number">2</span>);
    <span class="keyword">let</span> <span class="variable">f</span> = <span class="keyword">async</span> &#123;
        <span class="keyword">let</span> <span class="variable">a</span> = task1.<span class="keyword">await</span>;
        <span class="built_in">println!</span>(<span class="string">&quot;task&#123;&#125; finished&quot;</span>, a);
        <span class="keyword">let</span> <span class="variable">b</span> = task2.<span class="keyword">await</span>;
        <span class="built_in">println!</span>(<span class="string">&quot;task&#123;&#125; finished&quot;</span>, b);
    &#125;;
    <span class="title function_ invoke__">block_on</span>(f);
    <span class="comment">// after here, reactor has been destroyed, and the drop method will be called.</span>
    <span class="comment">// which means the timer loop will be broken and all timer thread will run.</span>
    <span class="comment">// åœ¨è¿™é‡Œï¼Œreactorå·²ç»è¢«é”€æ¯ï¼Œdropæ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œå®šæ—¶å™¨å¾ªç¯ä¼šè¢«æ‰“æ–­ï¼Œæ‰€æœ‰çš„å®šæ—¶å™¨çº¿ç¨‹éƒ½ä¼šè¿è¡Œ</span>
&#125;</code></pre>

<h4 id="ä¸€ä¸ªæ›´åŠ å®Œæ•´çš„ä½¿ç”¨ç”Ÿæˆå™¨æ¨¡æ‹ŸFutureçš„ä¾‹å­ï¼š"><a href="#ä¸€ä¸ªæ›´åŠ å®Œæ•´çš„ä½¿ç”¨ç”Ÿæˆå™¨æ¨¡æ‹ŸFutureçš„ä¾‹å­ï¼š" class="headerlink" title="ä¸€ä¸ªæ›´åŠ å®Œæ•´çš„ä½¿ç”¨ç”Ÿæˆå™¨æ¨¡æ‹ŸFutureçš„ä¾‹å­ï¼š"></a>ä¸€ä¸ªæ›´åŠ å®Œæ•´çš„ä½¿ç”¨ç”Ÿæˆå™¨æ¨¡æ‹ŸFutureçš„ä¾‹å­ï¼š</h4><pre><code class="highlight rust"><span class="meta">#![feature(generator_trait)]</span>
<span class="meta">#![feature(generators)]</span>

<span class="keyword">use</span> std::future::Future;
<span class="keyword">use</span> std::ops::&#123;Generator, GeneratorState&#125;;
<span class="keyword">use</span> std::pin::Pin;
<span class="keyword">use</span> std::sync::Arc;
<span class="keyword">use</span> std::task::&#123;Context, Poll, RawWaker, RawWakerVTable, Waker&#125;;
<span class="keyword">use</span> std::time::Duration;
<span class="keyword">use</span> tokio::time::Instant;

<span class="keyword">struct</span> <span class="title class_">Timer</span> &#123;
    delay_sec: <span class="type">u64</span>,
    when: Instant,
&#125;

<span class="keyword">impl</span> <span class="title class_">Timer</span> &#123;
    <span class="keyword">fn</span> <span class="title function_">new</span>(delay_sec: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;
        Timer &#123;
            delay_sec,
            when: Instant::<span class="title function_ invoke__">now</span>() + Duration::<span class="title function_ invoke__">from_secs</span>(delay_sec),
        &#125;
    &#125;

    <span class="keyword">fn</span> <span class="title function_">poll</span>(<span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">mut</span> <span class="keyword">Self</span>&gt;, waker: Waker) <span class="punctuation">-&gt;</span> Poll&lt;<span class="type">String</span>&gt; &#123;
        <span class="keyword">return</span> <span class="keyword">if</span> Instant::<span class="title function_ invoke__">now</span>() &gt;= <span class="keyword">self</span>.when &#123;
            Poll::<span class="title function_ invoke__">Ready</span>(<span class="built_in">format!</span>(<span class="string">&quot;run after &#123;&#125; seconds&quot;</span>, <span class="keyword">self</span>.delay_sec))
        &#125; <span class="keyword">else</span> &#123;
            <span class="keyword">let</span> <span class="variable">delay_sec</span> = <span class="keyword">self</span>.delay_sec;
            std::thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;
                std::thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(delay_sec));
                waker.<span class="title function_ invoke__">wake</span>();
            &#125;);
            Poll::Pending
        &#125;
    &#125;
&#125;

<span class="keyword">struct</span> <span class="title class_">Task</span> &#123;
    <span class="comment">// ç®€å•èµ·è§ï¼Œä¸ç”¨Contextï¼Œä¸ç„¶ä¼šå¼•å…¥ä¸€å¤§å †ç”Ÿå‘½å‘¨æœŸé—®é¢˜</span>
    generator: Pin&lt;<span class="type">Box</span>&lt;<span class="keyword">dyn</span> Generator&lt;Waker, Yield=Poll&lt;()&gt;, Return=()&gt;&gt;&gt;,
&#125;

<span class="keyword">impl</span> <span class="title class_">Task</span> &#123;
    <span class="keyword">fn</span> <span class="title function_">new</span>(delay_queue: <span class="type">Vec</span>&lt;<span class="type">u64</span>&gt;) <span class="punctuation">-&gt;</span> Task &#123;
        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">gen</span> = <span class="keyword">move</span> |waker: Waker| &#123;
            <span class="built_in">println!</span>(<span class="string">&quot;task running...&quot;</span>);
            <span class="keyword">for</span> <span class="variable">delay</span> <span class="keyword">in</span> delay_queue.<span class="title function_ invoke__">into_iter</span>() &#123;
                <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">timer</span> = Timer::<span class="title function_ invoke__">new</span>(delay);
                <span class="comment">// æœ€æ ¸å¿ƒçš„åœ¨è¿™é‡Œï¼Œè¿™é‡Œå¤§æ¦‚å±•ç¤ºäº† éå¶å­Futureæ˜¯æ€ä¹ˆæŠŠawaitè½¬æ¢æˆyieldæ“ä½œçš„</span>
                <span class="keyword">loop</span> &#123;
                    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">timer_mut</span> = &amp;<span class="keyword">mut</span> timer;
                    <span class="keyword">let</span> <span class="variable">timer_pin</span> = Pin::<span class="title function_ invoke__">new</span>(timer_mut);
                    <span class="keyword">let</span> <span class="variable">poll_res</span> = timer_pin.<span class="title function_ invoke__">poll</span>(waker.<span class="title function_ invoke__">clone</span>());
                    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Poll</span>::<span class="title function_ invoke__">Ready</span>(<span class="type">str</span>) = poll_res &#123;
                        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="type">str</span>);
                        <span class="keyword">break</span>;
                    &#125; <span class="keyword">else</span> &#123;
                        <span class="keyword">yield</span> Poll::Pending;
                    &#125;
                &#125;
            &#125;;
        &#125;;
        <span class="keyword">let</span> <span class="variable">gen_pin</span> = Pin::<span class="title function_ invoke__">new</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(gen));
        Task &#123;
            generator: gen_pin,
        &#125;
    &#125;

    <span class="keyword">fn</span> <span class="title function_">poll</span>(<span class="keyword">mut</span> <span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">mut</span> <span class="keyword">Self</span>&gt;, waker: Waker) <span class="punctuation">-&gt;</span> Poll&lt;()&gt; &#123;
        <span class="keyword">return</span> <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">GeneratorState</span>::<span class="title function_ invoke__">Yielded</span>(_) = <span class="keyword">self</span>.generator.<span class="title function_ invoke__">as_mut</span>().<span class="title function_ invoke__">resume</span>(waker.<span class="title function_ invoke__">clone</span>()) &#123;
            Poll::Pending
        &#125; <span class="keyword">else</span> &#123;
            Poll::<span class="title function_ invoke__">Ready</span>(())
        &#125;
    &#125;
&#125;

<span class="keyword">const</span> VTABLE: RawWakerVTable = <span class="keyword">unsafe</span> &#123;
    RawWakerVTable::<span class="title function_ invoke__">new</span>(
        |data| &#123;
            RawWaker::<span class="title function_ invoke__">new</span>(data, &amp;VTABLE)
        &#125;,
        |data| &#123;
        &#125;,
        |data| &#123;
        &#125;,
        |data| &#123;
        &#125;,
    )
&#125;;

<span class="keyword">fn</span> <span class="title function_">main</span>() &#123;
    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">task</span> = Task::<span class="title function_ invoke__">new</span>(<span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);
    <span class="keyword">loop</span> &#123;
        <span class="keyword">let</span> <span class="variable">task_pin</span> = Pin::<span class="title function_ invoke__">new</span>(&amp;<span class="keyword">mut</span> task);
        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Poll</span>::<span class="title function_ invoke__">Ready</span>(_) = task_pin.<span class="title function_ invoke__">poll</span>(<span class="keyword">unsafe</span> &#123;Waker::<span class="title function_ invoke__">from_raw</span>(RawWaker::<span class="title function_ invoke__">new</span>(std::ptr::<span class="title function_ invoke__">null</span>(), &amp;VTABLE))&#125;) &#123;
            <span class="keyword">break</span>;
        &#125;
        std::thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">200</span>));
    &#125;
&#125;</code></pre>



<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a target="_blank" rel="noopener" href="https://os.phil-opp.com/async-await/">Writing an OS in Rust-Async&#x2F;Await</a></p>
<p><a target="_blank" rel="noopener" href="https://doc.rust-lang.org/beta/unstable-book/language-features/generators.html">The Rust Unstable Book-generators</a></p>
<p><a target="_blank" rel="noopener" href="https://cfsamson.github.io/books-futures-explained/">Futures Explained in 200 Lines of Rust</a></p>
<p><a target="_blank" rel="noopener" href="https://boats.gitlab.io/blog/post/wakers-i/">The Waker API I: what does a waker do?</a></p>
<p><a target="_blank" rel="noopener" href="https://tmandry.gitlab.io/blog/posts/optimizing-await-1/">How Rust optimizes async&#x2F;await I</a></p>
<p><a target="_blank" rel="noopener" href="https://aturon.github.io/blog/2016/08/11/futures/">Zero-cost futures in Rust</a></p>

  <p><a class="classtest-link" href="/tags/Rust/" rel="tag">Rust</a>, <a class="classtest-link" href="/tags/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/" rel="tag">å¼‚æ­¥ç¼–ç¨‹</a> â€” Jan 8, 2024</p>
  


        </div>
        <div class="row mt-2">
  <h3>Search</h3>
  <div><input id="search-text" title="search" class="search-text" type="text" placeholder="search......"></div>
  <div style="margin-top: 1.5rem;">
    <ul id="result"></ul>
  </div>
</div>
        <div class="row mt-2">
  
    <div class="eight columns">
      <p id="madewith">Made with â¤ and
        <a class="footer-link icon" href="https://hexo.io" target="_blank" style="text-decoration: none;" rel="noreferrer" aria-label="Hexo.io">
        <svg class="hexo svg-hov" width="14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Hexo.js</title><path d="M12 .007L1.57 6.056V18.05L12 23.995l10.43-6.049V5.952L12 .007zm4.798 17.105l-.939.521-.939-.521V12.94H9.08v4.172l-.94.521-.938-.521V6.89l.939-.521.939.521v4.172h5.84V6.89l.94-.521.938.521v10.222z"/></svg>
        </a>
        
        at <a href="https://en.wikipedia.org/wiki/Earth" target="_blank" rel="noreferrer">Earth</a>.</p>
        
    </div>

    <!-- Sepcial thanks to https://simpleicons.org/ for the icons -->
    <div class="four columns mb-3 posisi" >
      
      <a class="ml-0 footer-link icon" href="https://github.com/adisaktijrs" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="GitHub">
        <svg class="github svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
      </a>
      

      
      <a class="ml-0 footer-link icon" href="https://linkedin.com/in/adisaktijrs" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="LinkedIn">
        <svg class="linkedin svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
      </a>
      

      
      <a class="ml-0 footer-link icon" href="https://twitter.com/adisaktijrs" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="Twitter">
        <svg class="twitter svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitter</title><path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717 0-4.92 2.203-4.92 4.917 0 .39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475 0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314 0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39 0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z"/></svg>
      </a>
      

      
      <a class="ml-0 footer-link icon" href="https://instagram.com/adisaktijrs" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="Instagram">
        <svg class="instagram svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Instagram</title><path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.306.788.717 1.459 1.384 2.126.667.666 1.336 1.079 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.788-.306 1.459-.718 2.126-1.384.666-.667 1.079-1.335 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.149-.558-2.913-.306-.789-.718-1.459-1.384-2.126C21.319 1.347 20.651.935 19.86.63c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.061 1.17-.256 1.805-.421 2.227-.224.562-.479.96-.899 1.382-.419.419-.824.679-1.38.896-.42.164-1.065.36-2.235.413-1.274.057-1.649.07-4.859.07-3.211 0-3.586-.015-4.859-.074-1.171-.061-1.816-.256-2.236-.421-.569-.224-.96-.479-1.379-.899-.421-.419-.69-.824-.9-1.38-.165-.42-.359-1.065-.42-2.235-.045-1.26-.061-1.649-.061-4.844 0-3.196.016-3.586.061-4.861.061-1.17.255-1.814.42-2.234.21-.57.479-.96.9-1.381.419-.419.81-.689 1.379-.898.42-.166 1.051-.361 2.221-.421 1.275-.045 1.65-.06 4.859-.06l.045.03zm0 3.678c-3.405 0-6.162 2.76-6.162 6.162 0 3.405 2.76 6.162 6.162 6.162 3.405 0 6.162-2.76 6.162-6.162 0-3.405-2.76-6.162-6.162-6.162zM12 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm7.846-10.405c0 .795-.646 1.44-1.44 1.44-.795 0-1.44-.646-1.44-1.44 0-.794.646-1.439 1.44-1.439.793-.001 1.44.645 1.44 1.439z"/></svg>
      </a>
      

      
      <a class="ml-0 footer-link icon" href="https://stackoverflow.com/story/tobiasreithmeier" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="StackOverflow">
        <svg class="stackoverflow svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Stack Overflow</title><path d="M15.725 0l-1.72 1.277 6.39 8.588 1.716-1.277L15.725 0zm-3.94 3.418l-1.369 1.644 8.225 6.85 1.369-1.644-8.225-6.85zm-3.15 4.465l-.905 1.94 9.702 4.517.904-1.94-9.701-4.517zm-1.85 4.86l-.44 2.093 10.473 2.201.44-2.092-10.473-2.203zM1.89 15.47V24h19.19v-8.53h-2.133v6.397H4.021v-6.396H1.89zm4.265 2.133v2.13h10.66v-2.13H6.154Z"/></svg>
      </a>
      

    </div>
  
</div>

      </div>

    </div>

  </div>
  <script src="/js/nanobar.min.js"></script>

  <script>
    var options = {
      classname: 'nanobar',
      id: 'myNanobar'
    };
    var nanobar = new Nanobar(options);
    nanobar.go(30);
    nanobar.go(76);
    nanobar.go(100);
  </script>

</body>

</html>